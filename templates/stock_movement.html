{% extends "base.html" %}

{% block content %}
<div class="container-fluid" style="max-width: 1000px; font-size:.9rem;">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold mb-0" style="color: indigo;">Stock Movement</h5>
    <!-- Optional: trigger to refresh or add filters -->
    <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()" hidden>Refresh</button>
  </div>

  <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
    <table class="table table-hover align-middle small" style="margin-bottom: 0; font-size:0.85rem;">
      <thead class="table-primary" style="position: sticky; top: 0; z-index: 2; background:#f8f9fa;">
        <tr>
          <th style="min-width:110px;">Date</th>
          <th style="min-width:120px;">Updater</th>
          <th style="min-width:120px;">Branch</th>
          <th style="min-width:160px;">Item</th>
          <th style="min-width:80px;">Quantity</th>
          <th style="min-width:90px;">Unit Cost</th>
          <th style="min-width:90px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for movement in stock_history|default([]) %}
        <tr style="height:24px; font-size:0.78rem;">
          <td class="py-0 text-truncate" style="max-width:110px; overflow:hidden;">{{ movement.date.strftime('%d %b %Y') }}</td>
          <td class="py-0 text-truncate" style="max-width:120px; overflow:hidden;">{{ movement.updater }}</td>
          <td class="py-0 text-truncate" style="max-width:120px; overflow:hidden;">{{ movement.branch }}</td>
          <td class="py-0 text-truncate" style="max-width:160px; overflow:hidden;">{{ movement.item }}</td>
          <td class="py-0 text-truncate" style="max-width:80px; overflow:hidden;">{{ movement.quantity_updated }}</td>
          <td class="py-0 text-truncate" style="max-width:90px; overflow:hidden;">{{ "{:,.0f}".format(movement.unit_cost) }}</td>
          <td class="py-0">
            {% if user.role in ["Manager", "Branch Manager"] %}
            <div class="d-flex gap-1">
              <button class="btn btn-sm px-2 py-1 border-0 shadow-sm"
                style="color: #0a58ca; border-radius: .35rem; min-width: 38px;"
                data-bs-toggle="modal" data-bs-target="#editStockMovementModal_{{ movement._id }}"
                title="Update Movement">
                <span class="ms-1 fw-semibold" style="font-size:.78rem;">edit</span>
              </button>
              <button class="btn btn-sm px-2 py-1 border-0 shadow-sm"
                style="color: #dc3545; border-radius: .35rem; min-width: 38px;"
                data-bs-toggle="modal" data-bs-target="#deleteStockMovementModal_{{ movement._id }}"
                title="Delete Movement">
                <i class="bi bi-x-circle"></i>
                <span class="ms-1 fw-semibold" style="font-size:.78rem;">Delete</span>
              </button>
            </div>
            {% else %}
              <span class="text-muted small fst-italic" style="font-size:0.75rem;">-</span>
            {% endif %}
          </td>
        </tr>
        <!-- Edit Movement Modal -->
        <div class="modal fade" id="editStockMovementModal_{{ movement._id }}" tabindex="-1"
             aria-labelledby="editStockMovementLabel_{{ movement._id }}" aria-hidden="true">
          <div class="modal-dialog modal-sm">
            <form method="POST" action="{{ url_for('edit_stock_movement') }}">
              <input type="hidden" name="movement_id" value="{{ movement._id }}">
              <input type="hidden" name="item_id" value="{{ movement.item_id }}">
              <div class="modal-content rounded-3">
                <div class="modal-header py-2">
                  <h6 class="modal-title" id="editStockMovementLabel_{{ movement._id }}">Edit Movement</h6>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.8);"></button>
                </div>
                <div class="modal-body py-2">
                  <div class="mb-2">
                    <label class="form-label small mb-1">Quantity</label>
                    <input type="number" name="quantity" class="form-control form-control-sm" value="{{ movement.quantity_updated }}" required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label small mb-1">Unit Cost</label>
                    <input type="number" name="unit_cost" class="form-control form-control-sm" value="{{ movement.unit_cost }}" required>
                  </div>
                </div>
                <div class="modal-footer py-2">
                  <button type="submit" class="btn btn-sm btn-primary">Save</button>
                </div>
              </div>
            </form>
          </div>
        </div>
        <!-- Delete Movement Modal -->
        <div class="modal fade" id="deleteStockMovementModal_{{ movement._id }}" tabindex="-1"
             aria-labelledby="deleteStockMovementLabel_{{ movement._id }}" aria-hidden="true">
          <div class="modal-dialog modal-sm">
            <form method="POST" action="{{ url_for('delete_stock_movement') }}">
              <input type="hidden" name="movement_id" value="{{ movement._id }}">
              <input type="hidden" name="item_id" value="{{ movement.item_id }}">
              <div class="modal-content rounded-3">
                <div class="modal-header py-2">
                  <h6 class="modal-title" id="deleteStockMovementLabel_{{ movement._id }}">Delete?</h6>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.8);"></button>
                </div>
                <div class="modal-body py-2">
                  <small>Remove movement record for <strong>{{ movement.item }}</strong>?</small>
                </div>
                <div class="modal-footer py-2">
                  <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                </div>
              </div>
            </form>
          </div>
        </div>
        {% else %}
        <tr>
          <td colspan="6" class="text-center text-muted fst-italic">No stock movement entries.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>
{% endblock %}
