{% extends "base.html" %}

{% block content %}
<div class="container-fluid" style="font-size:.9rem;">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold mb-0" style="color: indigo;">Stock Movement</h5>
    <!-- Optional: trigger to refresh or add filters -->
    <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()" hidden>Refresh</button>
  </div>

  <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
    <table class="table table-hover align-middle small" style="margin-bottom: 0; font-size:0.85rem;">
      <thead class="table-primary" style="position: sticky; top: 0; z-index: 2; background:#f8f9fa;">
        <tr>
            <th>Date</th>
            <th class="d-none d-md-table-cell">Updater</th>
            <th>Branch</th>
            <th>Item</th>
            <th>Quantity</th>
            <th>Unit Cost</th>
            <th class="d-none d-md-table-cell">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for movement in stock_history|default([]) %}
        <tr style="height:24px; font-size:0.78rem;">
          <td class="py-0 text-truncate">{{ movement.date.strftime('%d %b %Y') }}</td>
          <td class="py-0 text-truncate d-none d-md-table-cell">{{ movement.updater }}</td>
          <td class="py-0 text-truncate">{{ movement.branch }}</td>
          <td class="py-0 text-truncate">{{ movement.item }}</td>
          <td class="py-0 text-truncate">{{ movement.quantity_updated }}</td>
          <td class="py-0 text-truncate">{{ "{:,.0f}".format(movement.unit_cost) }}</td>
          <td class="py-0 d-none d-md-table-cell">
            {% if user.role in ["Manager", "Branch Manager", "Admin"] %}
            <div class="d-flex gap-1">
              <button class="btn btn-sm px-2 py-1 border-0 shadow-sm"
          style="color: #0a58ca; border-radius: .35rem;"
          data-bs-toggle="modal" data-bs-target="#editStockMovementModal_{{ movement._id }}"
          title="Update Movement">
          <span class="ms-1 fw-semibold" style="font-size:.78rem;">edit</span>
              </button>
              <button class="btn btn-sm px-2 py-1 border-0 shadow-sm"
          style="color: #dc3545; border-radius: .35rem;"
          data-bs-toggle="modal" data-bs-target="#deleteStockMovementModal_{{ movement._id }}"
          title="Delete Movement">
          <i class="bi bi-x-circle"></i>
          <span class="ms-1 fw-semibold" style="font-size:.78rem;">Delete</span>
              </button>
            </div>
            {% else %}
              <span class="text-muted small fst-italic" style="font-size:0.75rem;">-</span>
            {% endif %}
          </td>
        </tr>
        <!-- Edit Movement Modal -->
        <div class="modal fade" id="editStockMovementModal_{{ movement._id }}" tabindex="-1"
             aria-labelledby="editStockMovementLabel_{{ movement._id }}" aria-hidden="true">
          <div class="modal-dialog modal-sm">
            <form method="POST" action="{{ url_for('edit_stock_movement') }}">
              <input type="hidden" name="movement_id" value="{{ movement._id }}">
              <input type="hidden" name="item_id" value="{{ movement.item_id }}">
              <div class="modal-content rounded-3">
          <div class="modal-header py-2">
            <h6 class="modal-title" id="editStockMovementLabel_{{ movement._id }}">Edit Movement</h6>
            <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.8);"></button>
          </div>
          <div class="modal-body py-2">
            <div class="mb-2">
              <label class="form-label small mb-1">Date</label>
              <input type="date" name="date" class="form-control form-control-sm"
                value="{{ movement.date.strftime('%Y-%m-%d') }}" required>
            </div>
            <div class="mb-2">
              <label class="form-label small mb-1">Quantity</label>
              <input type="number" name="quantity" class="form-control form-control-sm" value="{{ movement.quantity_updated }}" required>
            </div>
            <div class="mb-2">
              <label class="form-label small mb-1">Unit Cost</label>
              <input type="number" name="unit_cost" class="form-control form-control-sm" value="{{ movement.unit_cost }}" required>
            </div>
          </div>
          <div class="modal-footer py-2">
            <button type="submit" class="btn btn-sm btn-primary">Save</button>
          </div>
              </div>
            </form>
          </div>
        </div>
        <!-- Delete Movement Modal -->
        <div class="modal fade" id="deleteStockMovementModal_{{ movement._id }}" tabindex="-1"
             aria-labelledby="deleteStockMovementLabel_{{ movement._id }}" aria-hidden="true">
          <div class="modal-dialog modal-sm">
            <form method="POST" action="{{ url_for('delete_stock_movement') }}">
              <input type="hidden" name="movement_id" value="{{ movement._id }}">
              <input type="hidden" name="item_id" value="{{ movement.item_id }}">
              <div class="modal-content rounded-3">
                <div class="modal-header py-2">
                  <h6 class="modal-title" id="deleteStockMovementLabel_{{ movement._id }}">Delete?</h6>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.8);"></button>
                </div>
                <div class="modal-body py-2">
                  <small>Remove movement record for <strong>{{ movement.item }}</strong>?</small>
                </div>
                <div class="modal-footer py-2">
                  <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                </div>
              </div>
            </form>
          </div>
        </div>
        {% else %}
        <tr>
          <td colspan="6" class="text-center text-muted fst-italic">No stock movement entries.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>


<div class="d-flex justify-content-center mt-2">
  <nav>
    <ul class="pagination pagination-sm mb-0">
      <li class="page-item {% if page <= 1 %}disabled{% endif %}">
        <a class="page-link" href="?page={{ page - 1 }}">«</a>
      </li>
      {% set start_page = page - 2 if page - 2 > 1 else 1 %}
      {% set end_page = start_page + 5 if start_page + 5 < total_pages else total_pages %}
      {% if end_page - start_page < 5 %}
        {% set start_page = end_page - 5 if end_page - 5 > 1 else 1 %}
      {% endif %}
      {% if start_page > 1 %}
        <li class="page-item"><a class="page-link" href="?page=1">1</a></li>
        {% if start_page > 2 %}
          <li class="page-item disabled"><span class="page-link">…</span></li>
        {% endif %}
      {% endif %}
      {% for p in range(start_page, end_page + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link" href="?page={{ p }}">{{ p }}</a>
        </li>
      {% endfor %}
      {% if end_page < total_pages %}
        {% if end_page < total_pages - 1 %}
          <li class="page-item disabled"><span class="page-link">…</span></li>
        {% endif %}
        <li class="page-item"><a class="page-link" href="?page={{ total_pages }}">{{ total_pages }}</a></li>
      {% endif %}
      <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
        <a class="page-link" href="?page={{ page + 1 }}">»</a>
      </li>
    </ul>
  </nav>
</div>


</div>
{% endblock %}
