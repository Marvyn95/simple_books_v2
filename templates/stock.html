{% extends "base.html" %}

{% block content %}
<div class="container-fluid" style="max-width: 900px;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold mb-0" style="color: indigo;">Stock Items</h4>
    {% if user.role == "Manager" or user.role == "Branch Manager" %}
      <button class="btn btn-sm px-3 fw-semibold shadow-sm" style="background: indigo; color:#fff; border-radius:.4rem; border:1.5px solid indigo;" data-bs-toggle="modal" data-bs-target="#addItemModal">
        <i class="bi bi-plus-lg me-1"></i> Add New Item
      </button>
    {% endif %}
  </div>

  <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
    {% if stock|length == 0 %}
      <div class="text-center text-muted py-4">
      <i class="bi bi-box-seam" style="font-size:2rem; color:indigo;"></i><br>
      <span class="fst-italic">No stock items available.</span>
      </div>
    {% else %}
    <table class="table table-hover align-middle small" style="margin-bottom:0; border-top:none; font-size:.85rem;">
      <thead class="table-primary" style="position:sticky; top:0; z-index:2;">
      <tr>
      <th style="max-width: 160px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Item</th>
      <th style="max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Branch</th>
      <th style="max-width: 80px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Quantity</th>
      <th style="max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Selling Price</th>
      <th style="max-width: 220px;">Actions</th>
      </tr>
      </thead>
      <tbody>
      {% for item in stock %}
      <tr style="height: 28px; font-size: .78rem;">
      <td class="fw-semibold py-0" style="max-width:160px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
        <a href="#" style="color: indigo; text-decoration: none;"
       data-bs-toggle="modal" data-bs-target="#itemDetailsModal_{{ item._id }}">
      {{ item.name }}
        </a>
      </td>
      <td class="py-0" style="max-width:120px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ item.branch }}</td>
      <td class="py-0" style="max-width:80px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ item.quantity }}</td>
      <td class="py-0" style="max-width:120px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
        {% if item.price %}
        ugx {{ "{:,.0f}".format(item.price) }}
        {% else %}
        Not Set
        {% endif %}
      </td>
      <td class="py-0" style="max-width:220px;">
        <div class="d-flex gap-2 justify-content-start align-items-center flex-wrap">
        {% if user.role == "Manager" or user.role == "Branch Manager" %}
        <button class="btn btn-sm px-2 py-1 border-0 shadow-sm" 
          style="color: indigo; border-radius: .35rem; min-width: 38px;" 
          data-bs-toggle="modal" data-bs-target="#itemDetailsModal_{{ item._id }}" 
          title="View Details">
          <span class="ms-1 fw-semibold" style="font-size:.78rem;">Details</span>
        </button>
        <button class="btn btn-sm px-2 py-1 border-0 shadow-sm" 
          style="color: #198754; border-radius: .35rem; min-width: 38px;" 
          data-bs-toggle="modal" data-bs-target="#updateStockModal{{ item._id }}" 
          title="Restock">
          <i class="bi bi-plus-circle"></i>
          <span class="ms-1 fw-semibold" style="font-size:.78rem;">Restock</span>
        </button>
        <button class="btn btn-sm px-2 py-1 border-0 shadow-sm" 
          style="color: #0a58ca; border-radius: .35rem; min-width: 38px;" 
          data-bs-toggle="modal" data-bs-target="#editItemModal{{ item._id }}" 
          title="Edit Item">
          <span class="ms-1 fw-semibold" style="font-size:.78rem;">Update</span>
        </button>
        <button class="btn btn-sm px-2 py-1 border-0 shadow-sm" 
          style="color: #dc3545; border-radius: .35rem; min-width: 38px;" 
          data-bs-toggle="modal" data-bs-target="#deleteItemModal{{ item._id }}" 
          title="Delete Item">
          <i class="bi bi-x-circle"></i>
          <span class="ms-1 fw-semibold" style="font-size:.78rem;">Delete</span>
        </button>
        {% else %}
        <button class="btn btn-sm px-2 py-1 border-0 shadow-sm" 
          style="color: indigo; border-radius: .35rem; min-width: 38px;" 
          data-bs-toggle="modal" data-bs-target="#itemDetailsModal_{{ item._id }}" 
          title="View Details">
          <i class="bi bi-info-circle"></i>
          <span class="ms-1 fw-semibold" style="font-size:.78rem;">Details</span>
        </button>
        {% endif %}
        </div>
      </td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
    {% endif %}
  </div>
</div>

<!-- Modals (placed AFTER table to keep HTML valid) -->
{% for item in stock %}
  <!-- Item Details Modal -->
  <div class="modal fade" id="itemDetailsModal_{{ item._id }}" tabindex="-1" aria-labelledby="itemDetailsModalLabel_{{ item._id }}" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 600px;">
      <div class="modal-content" style="background-color:#f8f9ff; font-size:.8rem; border-radius:.75rem;">
        <div class="modal-header border-bottom py-2">
          <h6 class="modal-title fw-semibold" id="itemDetailsModalLabel_{{ item._id }}" style="color: indigo;">
            <i class="bi bi-info-circle-fill me-2" style="color: indigo;"></i>Stock Details â€“ {{ item.name }}
          </h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.8);" aria-label="Close"></button>
        </div>
        <div class="modal-body px-3 py-2">
          <div class="mb-3">
            <div class="mb-2">
              <small style="color: indigo;">Item Name</small><br>
              <span class="fw-semibold text-dark">{{ item.name }}</span>
            </div>
            <div class="d-flex flex-wrap gap-3">
              <div>
                <small style="color: indigo;">Quantity</small><br>
                <span class="fw-semibold">{{ item.quantity }}</span>
              </div>
              <div>
                <small style="color: indigo;">Unit Price</small><br>
                {% if item.price %}
                  <span class="fw-semibold">ugx {{ "{:,.0f}".format(item.price) }}</span>
                {% else %}
                  <span class="text-muted fst-italic">Not Set</span>
                {% endif %}
              </div>
              <div>
                <small style="color: indigo;">Branch</small><br>
                <span class="fw-semibold">{{ item.branch }}</span>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <h6 class="fw-semibold mb-2" style="font-size:.8rem; color: indigo;">
              <i class="bi bi-clock-history me-1" style="color: indigo;"></i>Re-stocking History
            </h6>
            <div class="table-responsive" style="max-height:180px; overflow-y:auto;">
              <table class="table table-sm table-borderless mb-0">
                <thead class="border-bottom" style="color: indigo;">
                  <tr>
                    <th style="width:30%;">Date</th>
                    <th style="width:30%;">Updated By</th>
                    <th style="width:20%;">Qty</th>
                    <th style="width:20%;">Unit Cost</th>
                  </tr>
                </thead>
                <tbody>
                  {% set iid = item._id|string %}
                  {% set has_history = false %}
                  {% for entry in stock_history %}
                    {% if entry.item_id|string == iid %}
                      {% set has_history = true %}
                      <tr style="border-bottom:1px solid #e2e6ea;">
                        <td>
                          {# Formats datetime to: 05 Sep 2025 #}
                          {% if entry.date.__class__.__name__ == 'datetime' %}
                            {{ entry.date.strftime('%d %b %Y') }}
                          {% else %}
                            {{ entry.date }}
                          {% endif %}
                        </td>
                        <td>{{ entry.updater }}</td>
                        <td>{{ entry.quantity_updated }}</td>
                        <td>
                          {% if entry.unit_cost %}
                          ugx {{ "{:,.0f}".format(entry.unit_cost) }}
                          {% else %}
                          <span class="text-muted fst-italic">Not Set</span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                  {% if not has_history %}
                    <tr><td colspan="4" class="text-center text-muted fst-italic py-2">No history available.</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="modal-footer py-2">
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Item Modal -->
  <div class="modal fade" id="editItemModal{{ item._id }}" tabindex="-1" aria-labelledby="editItemLabel{{ item._id }}" aria-hidden="true">
    <div class="modal-dialog">
      <form method="POST" action="{{ url_for('edit_item') }}">
        <input type="hidden" name="item_id" value="{{ item._id }}">
        <input type="hidden" name="organization_id" value="{{ item.organization_id }}">
        <div class="modal-content rounded-3">
          <div class="modal-header bg-indigo text-white">
            <h5 class="modal-title" id="editItemLabel{{ item._id }}">Edit for {{ item.name }}</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label text-indigo fw-medium">Branch</label>
              {% if user.role == "Manager" %}
              <select name="branch_id" class="form-select form-select-sm" required>
                {% for branch in organization['branches'] %}
                  <option value="{{ branch._id }}" {% if item.branch_id|string == branch._id|string %}selected{% endif %}>
                    {{ branch['branch'] }}
                  </option>
                {% endfor %}
              </select>
              {% else %}
              <input type="text" class="form-control form-control-sm"
                     value="{% for branch in organization['branches'] %}{% if item.branch_id|string == branch._id|string %}{{ branch['branch'] }}{% endif %}{% endfor %}"
                     disabled>
              <input type="hidden" name="branch_id" value="{{ item.branch_id }}">
              {% endif %}
            </div>
            <div class="mb-3">
              <label class="form-label text-indigo fw-medium">Item Name</label>
              <input type="text" name="name" class="form-control form-control-sm" value="{{ item.name }}" required>
            </div>
            <div class="mb-3">
              <label class="form-label text-indigo fw-medium">Set Selling Price</label>
              <input type="number" name="price" class="form-control form-control-sm" value="{{ item.price }}" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-sm" style="background: indigo; color:#fff;">Save Changes</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Update Stock Modal -->
  <div class="modal fade" id="updateStockModal{{ item._id }}" tabindex="-1" aria-labelledby="updateStockLabel{{ item._id }}" aria-hidden="true">
    <div class="modal-dialog">
      <form method="POST" action="{{ url_for('update_stock') }}">
        <input type="hidden" name="item_id" value="{{ item._id }}">
        <input type="hidden" name="organization_id" value="{{ organization._id }}">
        <input type="hidden" name="user_id" value="{{ user._id }}">
        <input type="hidden" name="branch_id" value="{{ item.branch_id }}">
        <div class="modal-content rounded-3">
          <div class="modal-header bg-indigo text-white">
            <h5 class="modal-title" id="updateStockLabel{{ item._id }}">Update Stock for {{ item.name }}</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label text-indigo fw-medium">New Quantity</label>
              <input type="number" name="quantity" class="form-control form-control-sm" required>
            </div>
            <div class="mb-3">
              <label class="form-label text-indigo fw-medium">Unit Cost</label>
              <input type="number" name="unit_cost" class="form-control form-control-sm" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-sm" style="background:indigo; color:#fff;">Update</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Item Modal -->
  <div class="modal fade" id="deleteItemModal{{ item._id }}" tabindex="-1" aria-labelledby="deleteItemLabel{{ item._id }}" aria-hidden="true">
    <div class="modal-dialog">
      <form method="POST" action="{{ url_for('delete_item') }}">
        <input type="hidden" name="item_id" value="{{ item._id }}">
        <div class="modal-content rounded-3">
          <div class="modal-header bg-indigo text-white">
            <h5 class="modal-title" id="deleteItemLabel{{ item._id }}">Delete {{ item.name }}</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete <strong>{{ item.name }}</strong>?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
          </div>
        </div>
      </form>
    </div>
  </div>
{% endfor %}

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('add_item') }}">
      <div class="modal-content rounded-3">
        <div class="modal-header bg-indigo text-white">
          <h5 class="modal-title" id="addItemLabel">Add New Item</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {% if user.role == "Manager" %}
          <div class="mb-3">
            <label class="form-label text-indigo fw-medium">Branch</label>
            <select name="branch_id" class="form-select form-select-sm" required>
              <option value="" disabled {% if not selected_branch %}selected{% endif %}>Select Branch</option>
              {% for branch in organization['branches'] %}
                <option value="{{ branch._id }}" {% if selected_branch and selected_branch._id|string == branch._id|string %}selected{% endif %}>{{ branch['branch'] }}</option>
              {% endfor %}
            </select>
          </div>
          {% else %}
          <input type="hidden" name="branch_id" value="{{ selected_branch._id }}">
          {% endif %}
          <input type="hidden" name="organization_id" value="{{ user.organization_id }}">
          <div class="mb-3">
            <label class="form-label text-indigo fw-medium">Item Name</label>
            <input type="text" name="name" class="form-control form-control-sm" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm" style="background: indigo; color:#fff;">Add Item</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}