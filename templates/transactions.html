{% extends "base.html" %}

{% block content %}
<div class="">

  <!-- Action Tiles -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <!-- Heading on the left -->
    <h4 class="mb-0 fw-bold d-none d-sm-block" style="letter-spacing:0.5px; color: indigo;">Transactions</h4>
    <!-- Buttons on the right -->
    <div class="ms-auto d-flex gap-2">
      <button type="button" class="btn btn-sm btn-gradient-success shadow-sm px-3 py-2 align-items-center gap-2"
          data-bs-toggle="modal" data-bs-target="#newSaleModal"
          style="background: linear-gradient(90deg, #28a745 60%, #218838 100%); color: #fff; border: none; font-weight: 500; border-radius: 0.4rem;">
        <i class="bi bi-cash-stack fs-5"></i>
        <span>Sale</span>
      </button>
      <button type="button" class="btn btn-sm btn-gradient-danger shadow-sm px-3 py-2 align-items-center gap-2"
          data-bs-toggle="modal" data-bs-target="#newExpenseModal"
          style="background: linear-gradient(90deg, #dc3545 60%, #c82333 100%); color: #fff; border: none; font-weight: 500; border-radius: 0.4rem;">
        <i class="bi bi-receipt fs-5"></i>
        <span>Expense</span>
      </button>
    </div>
  </div>

  <!-- Transactions Table -->
  <div class="table-responsive" style="max-height: 420px; overflow-y: auto;">
    <table class="table table-hover table-sm table-borderless align-middle small mb-8" style="margin-bottom:0; font-size:.8rem;">
      <thead class="table-primary" style="position:sticky; top:0; z-index:2; background:#f8f9fa;">
      <tr>
      <th>Date</th>
      <th>Type</th>
      <th class="d-none d-sm-table-cell">User</th>
      <th>Description</th>
      <th>Amount (UGX)</th>
      <th>Status</th>
      <th class="d-none d-sm-table-cell">Actions</th>
      </tr>
      </thead>
      <tbody>
      {% if transactions and transactions|length > 0 %}
      {% for tx in transactions %}
      <tr class="border-bottom">
      <td class="text-truncate" style="max-width:90px; overflow:hidden;">{{ tx.date.strftime('%d %b %Y') }}</td>
      <td class="text-truncate {% if tx.type=='Sale' %}text-success{% else %}text-danger{% endif %}" style="max-width:60px; overflow:hidden;">
      <a href="#" data-bs-toggle="modal" data-bs-target="#transactionModal_{{ tx._id }}" style="text-decoration:none; color:inherit;">
      {{ tx.type }}
      </a>
      </td>
      <td class="text-muted text-truncate d-none d-sm-table-cell" style="max-width:100px; overflow:hidden;">{{ tx.user_name }}</td>
      <td class="text-truncate" style="color: indigo; max-width:140px; overflow:hidden;" title="{{ tx.description }}">{{ tx.description }}</td>
      <td class="text-truncate" style="max-width:90px; overflow:hidden;">{{ "{:,.0f}".format(tx.amount) }}</td>
      <td class="text-truncate" style="max-width:60px; overflow:hidden; {% if tx.status=='paid' %}color:green;{% elif tx.status=='credit' %}color:red;{% else %}color:gray;{% endif %}">
      {{ tx.status|capitalize if tx.status else 'â€”' }}
      </td>
      <td class="text-truncate d-none d-sm-table-cell" style="max-width:90px; overflow:hidden;">
      <div class="d-flex flex-nowrap gap-1 justify-content-start align-items-center" style="flex-wrap:nowrap;">
      {% if (tx.type=='Sale' and (user._id|string)==(tx.user_id|string)) or (tx.type=='Expense' and (user._id|string)==(tx.user_id|string)) %}
      <button class="btn btn-xs px-2 py-0 rounded-pill text-primary fw-semibold"
      data-bs-toggle="modal" data-bs-target="#transactionModal_{{ tx._id }}"
      style="font-size:0.72rem; background:rgba(0,123,255,0.12); border:none; min-width:38px;">
        <i class="bi bi-pencil-square"></i>
      </button>
      {% else %}
      <button class="btn btn-xs px-2 py-0 rounded-pill text-primary fw-semibold"
      data-bs-toggle="modal" data-bs-target="#transactionModal_{{ tx._id }}"
      style="font-size:0.72rem; background:rgba(0,123,255,0.12); border:none; min-width:38px;">
        <i class="bi bi-eye"></i>
      </button>
      {% endif %}
      {% if tx.type == 'Sale' and tx.status == 'credit' and (tx.user_id|string) == (user._id|string) %}
      <button class="btn btn-xs px-2 py-0 rounded-pill text-success fw-semibold"
      data-bs-toggle="modal" data-bs-target="#clearCreditModal_{{ tx._id }}"
      style="font-size:0.72rem; background:rgba(40,167,69,0.12); border:none; min-width:38px;">
        Clear
      </button>
      {% endif %}
      {% if tx.type == 'Sale' %}
      <form method="POST" action="{{ url_for('print_receipt') }}" style="display:inline;">
        <input type="hidden" name="organization" value="{{ organization.organization }}">
        <input type="hidden" name="user_id" value="{{ tx.user_id }}">
        <input type="hidden" name="tx_id" value="{{ tx._id }}">
        <input type="hidden" name="organization_id" value="{{ tx.organization_id }}">
        <input type="hidden" name="date" value="{{ tx.date.strftime('%d %b %Y') }}">
        <input type="hidden" name="client_name" value="{{ tx.client_name or '' }}">
        <input type="hidden" name="client_contact" value="{{ tx.client_contact or '' }}">
        <input type="hidden" name="seller" value="{{ tx.user_name }}">
        <input type="hidden" name="branch_id" value="{{ tx.branch_id }}">
        <button type="submit"
          class="btn btn-xs px-2 py-0 rounded-pill text-primary fw-semibold"
          style="font-size:0.72rem; background:rgba(0,123,255,0.12); border:none; min-width:38px;"
          title="Print Receipt">
          <i class="bi bi-printer"></i>
        </button>
      </form>
      {% endif %}
      {% if user.role == 'Manager' %}
      <button class="btn btn-sm btn-light px-1 py-0"
      style="font-size:.7rem; line-height:1; color:#dc3545;"
      data-bs-toggle="modal" data-bs-target="#deleteTxModal_{{ tx._id }}">
      <i class="bi bi-trash" style="font-size:1em;"></i>
      </button>
      {% endif %}
      </div>
      </td>
      </tr>
      {% endfor %}
      {% else %}
      <tr>
      <td colspan="8" class="text-center text-muted fst-italic py-4">No transactions found.</td>
      </tr>
      {% endif %}
      </tbody>
    </table>

    <!-- Delete Transaction Modals -->
    {% for tx in transactions %}
      {% if (user._id|string)==(tx.user_id|string) %}
      <div class="modal fade" id="deleteTxModal_{{ tx._id }}" tabindex="-1" aria-labelledby="deleteTxLabel_{{ tx._id }}" aria-hidden="true">
      <div class="modal-dialog">
        <form method="POST" action="{{ url_for('delete_transaction') }}">
        <input type="hidden" name="tx_id" value="{{ tx._id }}">
        <input type="hidden" name="tx_type" value="{{ tx.type }}">
        <div class="modal-content" style="background-color:#fffbe9; font-size:.85rem;">
          <div class="modal-header border-bottom py-2">
          <h6 class="modal-title fw-semibold text-danger" id="deleteTxLabel_{{ tx._id }}">
            <i class="bi bi-trash me-2"></i>Delete Transaction
          </h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.85);"></button>
          </div>
          <div class="modal-body px-3 py-2">
          <div class="mb-2">
            Are you sure you want to delete this transaction?<br>
            <span class="text-muted small">This action cannot be undone.</span>
          </div>
          <div class="mb-2">
            <strong>Date:</strong> {{ tx.date.strftime('%d %b %Y') }}<br>
            <strong>Type:</strong> {{ tx.type }}<br>
            <strong>Description:</strong> {{ tx.description }}
          </div>
          </div>
          <div class="modal-footer py-2">
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm btn-danger">Delete</button>
          </div>
        </div>
        </form>
      </div>
      </div>
      {% endif %}
    {% endfor %}
    <style>
      .table td.text-truncate, .table th.text-truncate {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      /* Prevent action buttons from wrapping to next line */
      .table td .d-flex.flex-nowrap {
        flex-wrap: nowrap !important;
      }
      .table td .btn {
        min-width: 32px;
        padding-left: 0.3rem;
        padding-right: 0.3rem;
        font-size: 0.72rem;
        line-height: 1.2;
      }
      @media (max-width: 600px) {
        .table td, .table th {
          font-size: 0.72rem;
        }
        .table td .btn {
          font-size: 0.68rem;
          min-width: 28px;
          padding-left: 0.2rem;
          padding-right: 0.2rem;
        }
        .table td .d-flex.flex-nowrap {
          gap: 0.2rem !important;
        }
        /* Hide User and Actions columns on small screens */
        .table th.d-none.d-sm-table-cell,
        .table td.d-none.d-sm-table-cell {
          display: none !important;
        }
      }
    </style>
  </div>

</div>

<!-- New Sale Modal -->
<div class="modal fade" id="newSaleModal" tabindex="-1" aria-labelledby="newSaleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('new_sale') }}">
      <input type="hidden" name="user_id" value="{{ user._id }}">
      <input type="hidden" name="org_id" value="{{ organization._id }}">
      <div class="modal-content" style="background-color:#f8f9ff; font-size:.75rem;">
        <div class="modal-header border-bottom py-2">
          <h6 class="modal-title fw-semibold text-success" id="newSaleModalLabel">
            <i class="bi bi-cash-stack me-2"></i>New Sale
          </h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.85);"></button>
        </div>
        <div class="modal-body px-3 py-2">
          <input type="hidden" name="user_id" value="{{ user._id }}">
          {% if user.role=='Manager' %}
            <div class="mb-2">
              <label class="form-label fw-semibold text-dark">Branch</label>
              <select name="branch_id" class="form-select form-select-sm" required>
          <option value="" disabled selected>Select Branch</option>
          {% for branch in organization.branches %}
            <option value="{{ branch._id }}"
              {% if branch._id == selected_branch._id %}selected{% endif %}>
              {{ branch.branch }}
            </option>
          {% endfor %}
              </select>
            </div>
          {% else %}
            <input type="hidden" name="branch_id" value="{{ selected_branch._id }}">
          {% endif %}
          <div id="saleItemsContainer">
            <div class="row mb-2 g-2 sale-item-row">
              <div class="col-5">
          <label class="form-label fw-semibold text-dark">Item</label>
          <select class="form-select form-select-sm saleItemSelect" required>
            <option value="" disabled selected>Select Item</option>
            {% for item in stock_items %}
            <option value="{{ item._id }}" data-price="{{ item.price }}">
              {{ item.name }}{% if item.price %} (ugx {{ "{:,.0f}".format(item.price) }}){% endif %}
            </option>
            {% endfor %}
          </select>
          <input type="hidden" name="item_id[]" class="saleItemIdInput">
              </div>
              <div class="col-3">
          <label class="form-label fw-semibold text-dark">Quantity</label>
          <input type="number" name="quantity[]" min="1" step="1" class="form-control form-control-sm saleQty" required>
              </div>
              <div class="col-4">
          <label class="form-label fw-semibold text-dark">Unit Price (UGX)</label>
          <input type="number" name="unit_price[]" min="0" step="1" class="form-control form-control-sm saleUnitPrice" required style="color:blue; font-weight:500;" readonly>
              </div>
            </div>
          </div>
            <div class="mb-2 d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary" id="addSaleItemRow">
              <i class="bi bi-plus-circle"></i> Add sale item
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger" id="removeSaleItemRow">
              <i class="bi bi-dash-circle"></i> Remove last item
            </button>
            <script>
              document.addEventListener("DOMContentLoaded", function() {
              const container = document.getElementById("saleItemsContainer");
              const removeBtn = document.getElementById("removeSaleItemRow");
              removeBtn.addEventListener("click", function() {
                const rows = container.querySelectorAll(".sale-item-row");
                if (rows.length > 1) {
                rows[rows.length - 1].remove();
                // Update totals and credit requirement after removal
                if (typeof updateTotalAmount === "function") updateTotalAmount();
                if (typeof updateCreditRequirement === "function") updateCreditRequirement();
                }
              });
              });
            </script>
            </div>
          <script>
          document.addEventListener("DOMContentLoaded", function() {
            function updateUnitPrice(row) {
              const select = row.querySelector(".saleItemSelect");
              const unitPriceInput = row.querySelector(".saleUnitPrice");
              const itemIdInput = row.querySelector(".saleItemIdInput");
              const selectedOpt = select.options[select.selectedIndex];
              const price = selectedOpt ? selectedOpt.getAttribute("data-price") : "";
              unitPriceInput.value = price ? parseFloat(price).toFixed(0) : "";
              itemIdInput.value = select.value;
            }

            function attachRowEvents(row) {
              const select = row.querySelector(".saleItemSelect");
              const qtyInput = row.querySelector(".saleQty");
              select.addEventListener("change", function() {
          updateUnitPrice(row);
          updateTotalAmount();
          updateCreditRequirement();
              });
              qtyInput.addEventListener("input", function() {
          updateTotalAmount();
          updateCreditRequirement();
              });
              // Initial update
              updateUnitPrice(row);
            }

            function updateTotalAmount() {
              const rows = document.querySelectorAll("#saleItemsContainer .sale-item-row");
              let total = 0;
              rows.forEach(row => {
          const qty = parseFloat(row.querySelector(".saleQty").value) || 0;
          const price = parseFloat(row.querySelector(".saleUnitPrice").value) || 0;
          total += qty * price;
              });
              const amountPaidInput = document.getElementById("saleAmountPaid");
              if (amountPaidInput) {
          amountPaidInput.value = total > 0 ? total.toFixed(0) : "";
              }
            }

            function updateCreditRequirement() {
              const rows = document.querySelectorAll("#saleItemsContainer .sale-item-row");
              let total = 0;
              rows.forEach(row => {
          const qty = parseFloat(row.querySelector(".saleQty").value) || 0;
          const price = parseFloat(row.querySelector(".saleUnitPrice").value) || 0;
          total += qty * price;
              });
              const amountPaidInput = document.getElementById("saleAmountPaid");
              const paid = parseFloat(amountPaidInput.value) || 0;
              const clientName = document.getElementById("saleClientName");
              const clientContact = document.getElementById("saleClientContact");
              const clientNameOpt = document.getElementById("saleClientNameOpt");
              const clientContactOpt = document.getElementById("saleClientContactOpt");
              if (total > 0 && paid < total) {
          clientName.required = true;
          clientContact.required = true;
          clientNameOpt.textContent = "";
          clientContactOpt.textContent = "";
              } else {
          clientName.required = false;
          clientContact.required = false;
          clientNameOpt.textContent = "(Optional)";
          clientContactOpt.textContent = "(Optional)";
              }
            }

            const container = document.getElementById("saleItemsContainer");
            const addBtn = document.getElementById("addSaleItemRow");
            attachRowEvents(container.querySelector(".sale-item-row"));

            addBtn.addEventListener("click", function() {
              const firstRow = container.querySelector(".sale-item-row");
              if (!firstRow) return;
              const newRow = firstRow.cloneNode(true);
              // Clear values in cloned row
              newRow.querySelectorAll("select, input").forEach(el => {
          if (el.classList.contains("saleItemSelect")) el.selectedIndex = 0;
          else el.value = "";
              });
              attachRowEvents(newRow);
              container.appendChild(newRow);
              updateTotalAmount();
              updateCreditRequirement();
            });

            // Update total and credit requirement if any row changes (for initial row)
            container.querySelectorAll(".saleQty, .saleItemSelect").forEach(el => {
              el.addEventListener("input", function() {
          updateTotalAmount();
          updateCreditRequirement();
              });
              el.addEventListener("change", function() {
          updateTotalAmount();
          updateCreditRequirement();
              });
            });

            // Also update credit requirement if amount paid is changed (should be readonly, but for safety)
            const amountPaidInput = document.getElementById("saleAmountPaid");
            if (amountPaidInput) {
              amountPaidInput.addEventListener("input", updateCreditRequirement);
              amountPaidInput.addEventListener("change", updateCreditRequirement);
            }

            // On form submit, collect all sale items into a list of dicts
            const saleForm = container.closest("form");
            if (saleForm) {
              saleForm.addEventListener("submit", function(e) {
              // Collect sale items
              const rows = container.querySelectorAll(".sale-item-row");
              const items = [];
              rows.forEach(row => {
                const item_id = row.querySelector(".saleItemSelect").value;
                const unit_price = row.querySelector(".saleUnitPrice").value;
                const quantity = row.querySelector(".saleQty").value;
                if (item_id && unit_price && quantity) {
                items.push({
                  item_id: item_id,
                  unit_price: unit_price,
                  quantity: quantity
                });
                }
              });
              // Set to hidden input
              let itemsInput = saleForm.querySelector("input[name='sale_items']");
              if (!itemsInput) {
                itemsInput = document.createElement("input");
                itemsInput.type = "hidden";
                itemsInput.name = "sale_items";
                saleForm.appendChild(itemsInput);
              }
              itemsInput.value = JSON.stringify(items);
              // The backend should parse sale_items as a JSON list of dicts
              });
            }

            // Initial requirement check
            updateCreditRequirement();
          });
          </script>
            <div class="mb-2">
            <label class="form-label fw-semibold text-dark">Amount Paid (UGX)</label>
            <input type="number" name="amount_paid" id="saleAmountPaid" min="0" step="1" class="form-control form-control-sm" required>
            </div>
            <script>
            // Ensure total updates when sale item rows are removed
            document.addEventListener("DOMContentLoaded", function() {
              const container = document.getElementById("saleItemsContainer");
              const amountPaidInput = document.getElementById("saleAmountPaid");
              function updateTotalAmount() {
              const rows = container.querySelectorAll(".sale-item-row");
              let total = 0;
              rows.forEach(row => {
                const qty = parseFloat(row.querySelector(".saleQty").value) || 0;
                const price = parseFloat(row.querySelector(".saleUnitPrice").value) || 0;
                total += qty * price;
              });
              if (amountPaidInput) {
                amountPaidInput.value = total > 0 ? total.toFixed(0) : "";
              }
              }
              // Listen for DOM changes in saleItemsContainer (row removal)
              const observer = new MutationObserver(updateTotalAmount);
              observer.observe(container, { childList: true });
            });
            </script>
          <div class="mb-2">
            <label class="form-label text-dark">Client Name <span class="text-muted" id="saleClientNameOpt">(Optional)</span></label>
            <input type="text" name="client_name" id="saleClientName" class="form-control form-control-sm">
          </div>
          <div>
            <label class="form-label text-dark">Client Contact <span class="text-muted" id="saleClientContactOpt">(Optional)</span></label>
            <input type="text" name="client_contact" id="saleClientContact" class="form-control form-control-sm">
          </div>
        </div>
        <div class="modal-footer py-2">
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm btn-success">Save Sale</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- New Expense Modal -->
<div class="modal fade" id="newExpenseModal" tabindex="-1" aria-labelledby="newExpenseModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('new_expense') }}">
      <div class="modal-content" style="background-color:#f8f9ff; font-size:.75rem;">
        <div class="modal-header border-bottom py-2">
          <h6 class="modal-title fw-semibold text-danger" id="newExpenseModalLabel">
            <i class="bi bi-receipt me-2"></i>New Expense
          </h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.85);"></button>
        </div>
        <div class="modal-body px-3 py-2">
          <input type="hidden" name="user_id" value="{{ user._id }}">
          <input type="hidden" name="org_id" value="{{ user.organization_id }}">
          {% if user.role=='Manager' %}
            <div class="mb-2">
            <label class="form-label fw-semibold text-dark">Branch</label>
            <select name="branch_id" class="form-select form-select-sm" required>
              <option value="" disabled selected>Select Branch</option>
              {% for branch in organization.branches %}
              <option value="{{ branch._id }}"
                {% if branch._id == selected_branch._id %}selected{% endif %}>
                {{ branch.branch }}
              </option>
              {% endfor %}
            </select>
            </div>
          {% endif %}
          <div class="mb-2">
            <label class="form-label fw-semibold text-dark">Purpose</label>
            <input type="text" name="purpose" class="form-control form-control-sm" required>
          </div>
          <div class="mb-2">
            <label class="form-label fw-semibold text-dark">Amount (UGX)</label>
            <input type="number" name="amount" min="0" step="0.01" class="form-control form-control-sm" required>
          </div>
          <div>
            <label class="form-label fw-semibold text-dark">Authorized By</label>
            <select name="authorized_by" class="form-select form-select-sm">
              <option value="" disabled selected>Select Authorizer</option>
              {% for emp in employees %}
                {% if emp.role in ['Branch Manager','Manager'] %}
                  <option value="{{ emp._id }}">{{ emp.username }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer py-2">
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm btn-danger">Save Expense</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Transaction Detail / Edit Modals -->
{% for tx in transactions %}
  {% if tx.type == 'Sale' %}
  <div class="modal fade" id="transactionModal_{{ tx._id }}" tabindex="-1" aria-labelledby="transactionModalLabel_{{ tx._id }}" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="background-color:#f8f9ff; font-size:.72rem;">
        <div class="modal-header border-bottom py-2">
          <h6 class="modal-title fw-semibold text-success" id="transactionModalLabel_{{ tx._id }}">
            <i class="bi bi-cash-stack me-2"></i>{% if (user._id|string)==(tx.user_id|string) %}Edit Sale{% else %}Sale Details{% endif %}
          </h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.85);"></button>
        </div>
        <div class="modal-body px-3 py-2">
          <div class="mb-2 pb-2 border-bottom">
            <div class="row g-2 mb-4">
              <div class="col-6"><strong>Date:</strong> {{ tx.date.strftime('%d %b %Y') }}</div>
              <div class="col-6"><strong>Time:</strong> {{ tx.date.strftime('%I:%M %p') }}</div>
              <div class="col-6"><strong>Client:</strong> {{ tx.client_name or 'Not recorded' }}</div>
              <div class="col-6"><strong>Contact:</strong> {{ tx.client_contact or 'Not recorded' }}</div>
              <div class="col-6"><strong>Status:</strong>
          <span style="{% if tx.status=='paid' %}color:green;{% elif tx.status=='credit' %}color:red;{% else %}color:gray;{% endif %}">
            {{ tx.status|capitalize }}
          </span>
              </div>
              <div class="col-6"><strong>Items: </strong>
                <span>{{ tx.description }}</span>
              </div>
              <div class="col-6"><strong>Amount paid:</strong> 
          <span class="text-primary">
            {{ "{:,.0f}".format(tx.quantity * tx.unit_price if tx.quantity and tx.unit_price else tx.amount) }}
          </span>
              </div>
              {% if tx.status=='credit' %}
              <div class="col-6"><strong>Amount Left:</strong>
                <span class="text-danger">
                  {{ "{:,.0f}".format(tx.payment_details.amount_left) }}
                </span>
              </div>
              {% endif %}
            </div>
            {% if tx.payment_details and tx.payment_details.clearance_history %}
            <div class="mt-2">
              <strong>Clearance History:</strong>
              <div class="table-responsive">
          <table class="table table-sm table-borderless mb-0" style="font-size:.65rem;">
            <thead><tr><th>Date & Time</th><th>Amount</th></tr></thead>
            <tbody>
              {% for entry in tx.payment_details.clearance_history %}
              <tr>
                <td>{{ entry.date.strftime('%d %b %Y') }} {{ entry.date.strftime('%H:%M') }}</td>
                <td>{{ "{:,.0f}".format(entry.amount_paid) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
              </div>
            </div>
            {% endif %}
          </div>

            {% if (user._id|string)==(tx.user_id|string) %}
            <form method="POST" action="{{ url_for('edit_sale') }}">
            <input type="hidden" name="user_id" value="{{ tx.user_id }}">
            <input type="hidden" name="tx_id" value="{{ tx._id }}">
            <div id="editSaleItemsContainer_{{ tx._id }}">
              {% for sale_item in tx.sale_items %}
                <div class="row mb-2 g-2 sale-item-row" style="font-size:0.72rem;">
                <div class="col-5">
                  <label class="form-label fw-semibold text-dark" style="font-size:0.72rem;">Item</label>
                  <select class="form-select form-select-sm saleItemSelect" required style="font-size:0.72rem;">
                  <option value="" disabled>Select Item</option>
                  {% for item in stock_items %}
                  <option value="{{ item._id }}" data-price="{{ item.price }}"
                    {% if sale_item.item_id | string == item._id | string %}selected{% endif %}>
                    {{ item.name }}{% if item.price %} (ugx {{ "{:,.0f}".format(item.price) }}){% endif %}
                  </option>
                  {% endfor %}
                  </select>
                  <input type="hidden" name="item_id[]" class="saleItemIdInput" value="{{ sale_item.item_id }}">
                </div>
                <div class="col-3">
                  <label class="form-label fw-semibold text-dark" style="font-size:0.72rem;">Quantity</label>
                  <input type="number" name="quantity[]" min="1" step="1" class="form-control form-control-sm saleQty" required value="{{ sale_item.quantity }}" style="font-size:0.72rem;">
                </div>
                <div class="col-4">
                  <label class="form-label fw-semibold text-dark" style="font-size:0.72rem;">Unit Price (UGX)</label>
                  <input type="number" name="unit_price[]" min="0" step="1" class="form-control form-control-sm saleUnitPrice" required style="color:blue; font-weight:500; font-size:0.72rem;" readonly value="{{ sale_item.unit_price }}">
                </div>
                </div>
                {% endfor %}
              </div>
              <div class="mb-2 d-flex gap-2">
                <button type="button" class="btn btn-sm btn-outline-primary" id="addEditSaleItemRow_{{ tx._id }}" style="font-size:0.72rem;">
                <i class="bi bi-plus-circle"></i> Add sale item
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" id="removeEditSaleItemRow_{{ tx._id }}" style="font-size:0.72rem;">
                <i class="bi bi-dash-circle"></i> Remove last item
                </button>
              </div>
            <script>
            document.addEventListener("DOMContentLoaded", function() {
              const container = document.getElementById("editSaleItemsContainer_{{ tx._id }}");
              const addBtn = document.getElementById("addEditSaleItemRow_{{ tx._id }}");
              const removeBtn = document.getElementById("removeEditSaleItemRow_{{ tx._id }}");
              const amountPaidInput = document.getElementById("editSaleAmountPaid_{{ tx._id }}");
              const clientName = document.getElementById("editSaleClientName_{{ tx._id }}");
              const clientContact = document.getElementById("editSaleClientContact_{{ tx._id }}");
              const clientNameOpt = document.getElementById("editSaleClientNameOpt_{{ tx._id }}");
              const clientContactOpt = document.getElementById("editSaleClientContactOpt_{{ tx._id }}");

              function updateUnitPrice(row) {
                const select = row.querySelector(".saleItemSelect");
                const unitPriceInput = row.querySelector(".saleUnitPrice");
                const itemIdInput = row.querySelector(".saleItemIdInput");
                const selectedOpt = select.options[select.selectedIndex];
                const price = selectedOpt ? selectedOpt.getAttribute("data-price") : "";
                unitPriceInput.value = price ? parseFloat(price).toFixed(0) : "";
                itemIdInput.value = select.value;
              }

              function attachRowEvents(row) {
                const select = row.querySelector(".saleItemSelect");
                const qtyInput = row.querySelector(".saleQty");
                select.addEventListener("change", function() {
                  updateUnitPrice(row);
                  updateTotalAmount();
                  updateCreditRequirement();
                });
                qtyInput.addEventListener("input", function() {
                  updateTotalAmount();
                  updateCreditRequirement();
                });
                // Initial update
                updateUnitPrice(row);
              }

              function updateTotalAmount() {
                const rows = container.querySelectorAll(".sale-item-row");
                let total = 0;
                rows.forEach(row => {
                  const qty = parseFloat(row.querySelector(".saleQty").value) || 0;
                  const price = parseFloat(row.querySelector(".saleUnitPrice").value) || 0;
                  total += qty * price;
                });
                if (amountPaidInput) {
                  amountPaidInput.value = total > 0 ? total.toFixed(0) : "";
                }
              }

              function updateCreditRequirement() {
                const rows = container.querySelectorAll(".sale-item-row");
                let total = 0;
                rows.forEach(row => {
                  const qty = parseFloat(row.querySelector(".saleQty").value) || 0;
                  const price = parseFloat(row.querySelector(".saleUnitPrice").value) || 0;
                  total += qty * price;
                });
                const paid = parseFloat(amountPaidInput.value) || 0;
                if (total > 0 && paid < total) {
                  if (clientName) clientName.required = true;
                  if (clientContact) clientContact.required = true;
                  if (clientNameOpt) clientNameOpt.textContent = "";
                  if (clientContactOpt) clientContactOpt.textContent = "";
                } else {
                  if (clientName) clientName.required = false;
                  if (clientContact) clientContact.required = false;
                  if (clientNameOpt) clientNameOpt.textContent = "(Optional)";
                  if (clientContactOpt) clientContactOpt.textContent = "(Optional)";
                }
              }

              // Attach events to initial row
              container.querySelectorAll(".sale-item-row").forEach(attachRowEvents);

              addBtn.addEventListener("click", function() {
                const firstRow = container.querySelector(".sale-item-row");
                if (!firstRow) return;
                const newRow = firstRow.cloneNode(true);
                // Clear values in cloned row
                newRow.querySelectorAll("select, input").forEach(el => {
                  if (el.classList.contains("saleItemSelect")) el.selectedIndex = 0;
                  else el.value = "";
                });
                attachRowEvents(newRow);
                container.appendChild(newRow);
                updateTotalAmount();
                updateCreditRequirement();
              });

              removeBtn.addEventListener("click", function() {
                const rows = container.querySelectorAll(".sale-item-row");
                if (rows.length > 1) {
                  rows[rows.length - 1].remove();
                  updateTotalAmount();
                  updateCreditRequirement();
                }
              });

              // Update total and credit requirement if any row changes (for initial row)
              container.querySelectorAll(".saleQty, .saleItemSelect").forEach(el => {
                el.addEventListener("input", function() {
                  updateTotalAmount();
                  updateCreditRequirement();
                });
                el.addEventListener("change", function() {
                  updateTotalAmount();
                  updateCreditRequirement();
                });
              });

              // Also update credit requirement if amount paid is changed
              if (amountPaidInput) {
                amountPaidInput.addEventListener("input", updateCreditRequirement);
                amountPaidInput.addEventListener("change", updateCreditRequirement);
              }

              // On form submit, collect all sale items into a list of dicts
              const saleForm = container.closest("form");
              if (saleForm) {
                saleForm.addEventListener("submit", function(e) {
                  const rows = container.querySelectorAll(".sale-item-row");
                  const items = [];
                  rows.forEach(row => {
                    const item_id = row.querySelector(".saleItemSelect").value;
                    const unit_price = row.querySelector(".saleUnitPrice").value;
                    const quantity = row.querySelector(".saleQty").value;
                    if (item_id && unit_price && quantity) {
                      items.push({
                        item_id: item_id,
                        unit_price: unit_price,
                        quantity: quantity
                      });
                    }
                  });
                  // Set to hidden input
                  let itemsInput = saleForm.querySelector("input[name='sale_items']");
                  if (!itemsInput) {
                    itemsInput = document.createElement("input");
                    itemsInput.type = "hidden";
                    itemsInput.name = "sale_items";
                    saleForm.appendChild(itemsInput);
                  }
                  itemsInput.value = JSON.stringify(items);
                });
              }

              // Initial requirement check
              updateCreditRequirement();

              // Ensure total updates when sale item rows are removed
              const observer = new MutationObserver(updateTotalAmount);
              observer.observe(container, { childList: true });
            });
            </script>
            <div class="mb-2">
              <label class="form-label fw-semibold text-dark" style="font-size:0.72rem;">Amount Paid (UGX)</label>
              <input type="number" name="amount_paid" id="editSaleAmountPaid_{{ tx._id }}" min="0" step="1" class="form-control form-control-sm" required value="{{ tx.amount }}" style="font-size:0.72rem;">
            </div>
            <div class="mb-2">
              <label class="form-label text-dark" style="font-size:0.72rem;">Client Name <span class="text-muted" id="editSaleClientNameOpt_{{ tx._id }}" style="font-size:0.72rem;">(Optional)</span></label>
              <input type="text" name="client_name" id="editSaleClientName_{{ tx._id }}" class="form-control form-control-sm" value="{{ tx.client_name or '' }}" style="font-size:0.72rem;">
            </div>
            <div>
              <label class="form-label text-dark" style="font-size:0.72rem;">Client Contact <span class="text-muted" id="editSaleClientContactOpt_{{ tx._id }}" style="font-size:0.72rem;">(Optional)</span></label>
              <input type="text" name="client_contact" id="editSaleClientContact_{{ tx._id }}" class="form-control form-control-sm" value="{{ tx.client_contact or '' }}" style="font-size:0.72rem;">
            </div>
            <div class="modal-footer py-2">
              <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal" style="font-size:0.72rem;">Cancel</button>
              <button type="submit" class="btn btn-sm btn-success" style="font-size:0.72rem;">Save Sale</button>
            </div>
            </form>
          {% else %}
          <div class="modal-footer py-2">
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {% elif tx.type == 'Expense' %}
  <div class="modal fade" id="transactionModal_{{ tx._id }}" tabindex="-1" aria-labelledby="transactionModalLabel_{{ tx._id }}" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="background-color:#f8f9ff; font-size:.72rem;">
        <div class="modal-header border-bottom py-2">
          <h6 class="modal-title fw-semibold text-danger" id="transactionModalLabel_{{ tx._id }}">
            <i class="bi bi-receipt me-2"></i>{% if (user._id|string)==(tx.user_id|string) %}Edit Expense{% else %}Expense Details{% endif %}
          </h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.85);"></button>
        </div>
        <div class="modal-body px-3 py-2">
          <div class="mb-2 pb-2 border-bottom">
            <div class="row g-2">
              <div class="col-6"><strong>Date:</strong> {{ tx.date.strftime('%d %b %Y') }}</div>
              <div class="col-6"><strong>Time:</strong> {{ tx.date.strftime('%I:%M %p') }}</div>
              <div class="col-12"><strong>Purpose:</strong> {{ tx.description or 'â€”' }}</div>
              <div class="col-6"><strong>Amount:</strong> {{ "{:,.0f}".format(tx.amount) }}</div>
              <div class="col-6"><strong>Authorized:</strong> {{ tx.authorizer or 'â€”' }}</div>
            </div>
          </div>
          {% if (user._id|string)==(tx.user_id|string) %}
          <form method="POST" action="{{ url_for('edit_expense') }}">
            <input type="hidden" name="user_id" value="{{ tx.user_id }}">
            <input type="hidden" name="tx_id" value="{{ tx._id }}">
            <div class="mb-2">
              <label class="form-label fw-semibold text-dark">Purpose</label>
              <input type="text" name="purpose" value="{{ tx.description }}" class="form-control form-control-sm" required>
            </div>
            <div class="mb-2">
              <label class="form-label fw-semibold text-dark">Amount (UGX)</label>
              <input type="number" name="amount" min="0" step="0.01" value="{{ tx.amount }}" class="form-control form-control-sm" required>
            </div>
            <div class="mb-2">
              <label class="form-label fw-semibold text-dark">Authorized By</label>
              <select name="authorized_by" class="form-select form-select-sm">
                <option value="" {% if not tx.authorized_by %}selected{% endif %}>Select Authorizer</option>
                {% for emp in employees %}
                  {% if emp.role == 'Branch Manager' or emp.role == 'Manager' %}
                    <option value="{{ emp._id }}" {% if (tx.authorized_by|string)==(emp._id|string) %}selected{% endif %}>{{ emp.username }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
            <div class="modal-footer py-2">
              <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-sm btn-danger">Save Expense</button>
            </div>
          </form>
          {% else %}
          <div class="modal-footer py-2">
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}
{% endfor %}

<!-- Clear Credit Modals (separate to keep table tidy) -->
{% for tx in transactions %}
  {% if tx.type == 'Sale' and tx.status == 'credit' and (tx.user_id|string) == (user._id|string) %}
  <!-- Clear Credit Modal -->
  <div class="modal fade" id="clearCreditModal_{{ tx._id }}" tabindex="-1" aria-labelledby="clearCreditLabel_{{ tx._id }}" aria-hidden="true">
    <div class="modal-dialog">
      <form method="POST" action="{{ url_for('clear_credit') }}">
        <div class="modal-content" style="background-color: #f8f9ff; font-size: 0.78rem;">
          <div class="modal-header border-bottom py-2">
        <h6 class="modal-title fw-semibold text-success" id="clearCreditLabel_{{ tx._id }}">
          <i class="bi bi-cash-coin me-2"></i>
              Clear Credit
              <span class="text-danger fw-normal" style="font-size: 0.85em;">
                ( ugx {{ "{:,.0f}".format(tx.payment_details.amount_left) }} left)
              </span>
            </h6>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="transform: scale(0.85);"></button>
          </div>
          <div class="modal-body px-3 py-2">
            <input type="hidden" name="user_id" value="{{ user._id }}">
            <input type="hidden" name="item_id" value="{{ tx.item_id }}">
            <input type="hidden" name="tx_id" value="{{ tx._id }}">
            <div class="mb-2">
              <label class="form-label fw-semibold text-dark" style="font-size: 0.72rem;">Amount to Clear (UGX)</label>
              <input type="number" name="amount" min="1" step="0.01" class="form-control form-control-sm" style="font-size: 0.72rem;" required>
            </div>
          </div>
          <div class="modal-footer py-2">
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-sm btn-success">Clear Credit</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
{% endfor %}

<!-- Scripts -->
<script>
// The code in $SELECTION_PLACEHOLDER$ is now redundant and can be removed.
// Your "New Sale" modal uses a new script block (with dynamic row logic) that covers all sale item/amount/credit logic.
// The edit sale modal logic is also handled inline per modal.
// You can safely delete the entire $SELECTION_PLACEHOLDER$ block.
</script>

{% endblock %}