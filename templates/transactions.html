{% extends "base.html" %}

{% block content %}
<div class="">

  <!-- Action Tiles -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <!-- Heading on the left -->
    <h4 class="mb-0 fw-bold d-none d-sm-block" style="letter-spacing:0.5px; color: indigo;">Transactions</h4>
    <!-- Buttons on the right -->
    <div class="ms-auto d-flex gap-2">
      <button type="button" class="btn btn-sm shadow-sm px-3 py-2" 
          data-bs-toggle="modal" data-bs-target="#newSaleModal"
          style="background-color: #10b981; color: #fff; border: none; font-weight: 600; border-radius: 0.5rem; font-size: 0.875rem; transition: all 0.2s ease;">
        <i class="bi bi-plus-circle me-2"></i>New Sale
      </button>
      <button type="button" class="btn btn-sm shadow-sm px-3 py-2" 
          data-bs-toggle="modal" data-bs-target="#newExpenseModal"
          style="background-color: #ef4444; color: #fff; border: none; font-weight: 600; border-radius: 0.5rem; font-size: 0.875rem; transition: all 0.2s ease;">
        <i class="bi bi-plus-circle me-2"></i>New Expense
      </button>
    </div>
  </div>

  <!-- Transactions Table -->
  <div class="table-responsive" style="max-height: 375px; overflow-y: auto;">
    <table class="table table-hover table-sm table-borderless align-middle small mb-8" style="margin-bottom:0; font-size:.8rem;">
      <thead class="table-primary" style="position:sticky; top:0; z-index:2; background:#f8f9fa;">
      <tr>
      <th>Date</th>
      <th>Type</th>
      <th class="d-none d-sm-table-cell">User</th>
      <th>Description</th>
      <th>Amount (UGX)</th>
      <th>Status</th>
      <th class="d-none d-sm-table-cell">Actions</th>
      </tr>
      </thead>
      <tbody>
      {% if transactions and transactions|length > 0 %}
      {% for tx in transactions %}
      <tr class="border-bottom">
      <td class="text-truncate" style="max-width:90px; overflow:hidden;">{{ tx.date.strftime('%d %b %Y') }}</td>
      <td class="text-truncate {% if tx.type=='Sale' %}text-success{% else %}text-danger{% endif %}" style="max-width:60px; overflow:hidden;">
      <a href="#" data-bs-toggle="modal" data-bs-target="#transactionModal_{{ tx._id }}" style="text-decoration:none; color:inherit;">
      {{ tx.type }}
      </a>
      </td>
      <td class="text-muted text-truncate d-none d-sm-table-cell" style="max-width:100px; overflow:hidden;">{{ tx.user_name }}</td>
      <td class="text-truncate" style="color: indigo; max-width:140px; overflow:hidden;" title="{{ tx.description }}">{{ tx.description }}</td>
      <td class="text-truncate" style="max-width:90px; overflow:hidden;">{{ "{:,.0f}".format(tx.amount) }}</td>
      <td class="text-truncate" style="max-width:60px; overflow:hidden; {% if tx.status=='paid' %}color:green;{% elif tx.status=='credit' %}color:red;{% else %}color:gray;{% endif %}">
      {{ tx.status|capitalize if tx.status else '—' }}
      </td>
      <td class="text-truncate d-none d-sm-table-cell" style="max-width:90px; overflow:hidden;">
      <div class="d-flex flex-nowrap gap-1 justify-content-start align-items-center" style="flex-wrap:nowrap;">
      {% if (tx.type=='Sale' and (user._id|string)==(tx.user_id|string)) or (tx.type=='Expense' and (user._id|string)==(tx.user_id|string)) %}
      <button class="btn btn-xs px-2 py-0 rounded-pill text-primary fw-semibold"
      data-bs-toggle="modal" data-bs-target="#transactionModal_{{ tx._id }}"
      style="font-size:0.72rem; background:rgba(0,123,255,0.12); border:none; min-width:38px;">
        <i class="bi bi-pencil-square"></i>
      </button>
      {% else %}
      <button class="btn btn-xs px-2 py-0 rounded-pill text-primary fw-semibold"
      data-bs-toggle="modal" data-bs-target="#transactionModal_{{ tx._id }}"
      style="font-size:0.72rem; background:rgba(0,123,255,0.12); border:none; min-width:38px;">
        <i class="bi bi-eye"></i>
      </button>
      {% endif %}
      {% if tx.type == 'Sale' and tx.status == 'credit' and (tx.user_id|string) == (user._id|string) %}
      <button class="btn btn-xs px-2 py-0 rounded-pill text-success fw-semibold"
      data-bs-toggle="modal" data-bs-target="#clearCreditModal_{{ tx._id }}"
      style="font-size:0.72rem; background:rgba(40,167,69,0.12); border:none; min-width:38px;">
        Clear
      </button>
      {% endif %}
      {% if tx.type == 'Sale' %}
      <form method="POST" action="{{ url_for('print_receipt') }}" style="display:inline;">
        <input type="hidden" name="organization" value="{{ organization.organization }}">
        <input type="hidden" name="user_id" value="{{ tx.user_id }}">
        <input type="hidden" name="tx_id" value="{{ tx._id }}">
        <input type="hidden" name="organization_id" value="{{ tx.organization_id }}">
        <input type="hidden" name="date" value="{{ tx.date.strftime('%d %b %Y') }}">
        <input type="hidden" name="client_name" value="{{ tx.client_name or '' }}">
        <input type="hidden" name="client_contact" value="{{ tx.client_contact or '' }}">
        <input type="hidden" name="seller" value="{{ tx.user_name }}">
        <input type="hidden" name="branch_id" value="{{ tx.branch_id }}">
        <button type="submit"
          class="btn btn-xs px-2 py-0 rounded-pill text-primary fw-semibold"
          style="font-size:0.72rem; background:rgba(0,123,255,0.12); border:none; min-width:38px;"
          title="Print Receipt">
          <i class="bi bi-printer"></i>
        </button>
      </form>
      {% endif %}
      {% if user.role == 'Manager' %}
      <button class="btn btn-sm btn-light px-1 py-0"
      style="font-size:.7rem; line-height:1; color:#dc3545;"
      data-bs-toggle="modal" data-bs-target="#deleteTxModal_{{ tx._id }}">
      <i class="bi bi-trash" style="font-size:1em;"></i>
      </button>
      {% endif %}
      </div>
      </td>
      </tr>
      {% endfor %}
      {% else %}
      <tr>
      <td colspan="8" class="text-center text-muted fst-italic py-4">No transactions found.</td>
      </tr>
      {% endif %}
      </tbody>
    </table>

    <!-- Delete Transaction Modals -->
    {% for tx in transactions %}
      {% if user.role == 'Manager' %}
      <div class="modal fade" id="deleteTxModal_{{ tx._id }}" tabindex="-1" aria-labelledby="deleteTxLabel_{{ tx._id }}" aria-hidden="true">
      <div class="modal-dialog">
        <form method="POST" action="{{ url_for('delete_transaction') }}">
        <input type="hidden" name="tx_id" value="{{ tx._id }}">
        <input type="hidden" name="tx_type" value="{{ tx.type }}">
        <div class="modal-content" style="background-color:#fffbe9; font-size:.85rem;">
          <div class="modal-header border-bottom py-2">
          <h6 class="modal-title fw-semibold text-danger" id="deleteTxLabel_{{ tx._id }}">
            <i class="bi bi-trash me-2"></i>Delete Transaction
          </h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.85);"></button>
          </div>
          <div class="modal-body px-3 py-2">
          <div class="mb-2">
            Are you sure you want to delete this transaction?<br>
            <span class="text-muted small">This action cannot be undone.</span>
          </div>
          <div class="mb-2">
            <strong>Date:</strong> {{ tx.date.strftime('%d %b %Y') }}<br>
            <strong>Type:</strong> {{ tx.type }}<br>
            <strong>Description:</strong> {{ tx.description }}
          </div>
          </div>
          <div class="modal-footer py-2">
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm btn-danger">Delete</button>
          </div>
        </div>
        </form>
      </div>
      </div>
      {% endif %}
    {% endfor %}
    <style>
      .table td.text-truncate, .table th.text-truncate {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      /* Prevent action buttons from wrapping to next line */
      .table td .d-flex.flex-nowrap {
        flex-wrap: nowrap !important;
      }
      .table td .btn {
        min-width: 32px;
        padding-left: 0.3rem;
        padding-right: 0.3rem;
        font-size: 0.72rem;
        line-height: 1.2;
      }
      @media (max-width: 600px) {
        .table td, .table th {
          font-size: 0.72rem;
        }
        .table td .btn {
          font-size: 0.68rem;
          min-width: 28px;
          padding-left: 0.2rem;
          padding-right: 0.2rem;
        }
        .table td .d-flex.flex-nowrap {
          gap: 0.2rem !important;
        }
        /* Hide User and Actions columns on small screens */
        .table th.d-none.d-sm-table-cell,
        .table td.d-none.d-sm-table-cell {
          display: none !important;
        }
      }
    </style>
  </div>

</div>



<!-- New Sale Modal -->
<div class="modal fade" id="newSaleModal" tabindex="-1" aria-labelledby="newSaleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="newSaleForm" method="POST" action="{{ url_for('new_sale') }}">
      
      <!-- Hidden fields -->
      <input type="hidden" name="user_id"          value="{{ user._id }}">
      <input type="hidden" name="org_id"           value="{{ organization._id }}">
      <input type="hidden" name="sale_items"       id="hiddenSaleItemsJson">

      <div class="modal-content" style="background-color: #f8f9ff; font-size: 0.75rem;">
        
        <!-- Header -->
        <div class="modal-header border-bottom py-2">
          <h6 class="modal-title fw-semibold text-success" id="newSaleModalLabel">
            <i class="bi bi-cash-stack me-2"></i>New Sale
          </h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform: scale(0.85);"></button>
        </div>

        <!-- Body -->
        <div class="modal-body px-3 py-2">

          <!-- Branch + Barcode row -->
          <div class="row g-3 mb-3 align-items-end">
            {% if user.role in ['Manager', 'Admin'] %}
              <div class="col-md-6">
                <label class="form-label fw-semibold text-dark">Branch</label>
                <select name="branch_id" class="form-select form-select-sm" required>
                  <option value="" disabled selected>Select Branch</option>
                  {% for branch in organization.branches %}
                    <option value="{{ branch._id }}"
                            {% if branch._id == selected_branch._id %}selected{% endif %}>
                      {{ branch.branch }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            {% else %}
              <input type="hidden" name="branch_id" value="{{ selected_branch._id }}">
            {% endif %}

            <div class="{% if user.role in ['Manager', 'Admin'] %}col-md-6{% else %}col-12{% endif %}">
              <label class="form-label fw-semibold text-dark">Scan / Enter Barcode</label>
              <input type="text" id="barcodeInput" class="form-control form-control-sm"
                     placeholder="Scan barcode..." autocomplete="off" autofocus>
            </div>
          </div>

          <!-- Sale Items Section -->
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <label class="form-label fw-semibold text-dark mb-0">Sale Items</label>
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-primary" id="btnAddItem">
                  <i class="bi bi-plus-circle"></i> Add Item
                </button>
                <button type="button" class="btn btn-outline-danger" id="btnRemoveLastItem">
                  <i class="bi bi-dash-circle"></i> Remove Last
                </button>
              </div>
            </div>

            <div id="saleItemsContainer">
              <!-- Template / initial empty row -->
              <div class="row g-2 mb-2 sale-item-row align-items-end">
                <div class="col-5">
                  <label class="form-label fw-semibold text-dark">Item</label>
                  <select class="form-select form-select-sm sale-item-select" required>
                    <option value="" disabled selected>Select Item</option>
                    {% for item in stock_items %}
                      <option value="{{ item._id }}"
                              data-price="{{ item.price }}"
                              data-barcode="{{ item.barcode or '' }}">
                        {{ item.name }}
                        {% if item.price %} (UGX {{ "{:,.0f}".format(item.price) }}) {% endif %}
                      </option>
                    {% endfor %}
                  </select>
                  <input type="hidden" name="item_id[]" class="sale-item-id">
                </div>
                <div class="col-3">
                  <label class="form-label fw-semibold text-dark">Qty</label>
                  <input type="number" name="quantity[]" class="form-control form-control-sm sale-qty"
                         min="1" value="1" step="1" required>
                </div>
                <div class="col-4">
                  <label class="form-label fw-semibold text-dark">Unit Price (UGX)</label>
                  <input type="number" name="unit_price[]" class="form-control form-control-sm sale-unit-price"
                         readonly style="color: blue; font-weight: 500;">
                </div>
              </div>
            </div>
          </div>

          <!-- Payment & Customer Info -->
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label fw-semibold text-dark">Amount Paid (UGX)</label>
              <input type="number" name="amount_paid" id="amountPaid" class="form-control form-control-sm"
                     min="0" step="1" required>
            </div>
            <div class="col-md-4">
              <label class="form-label text-dark">
                Client Name <span class="text-muted" id="clientNameOptional">(Optional)</span>
              </label>
              <input type="text" name="client_name" id="clientName" class="form-control form-control-sm">
            </div>
            <div class="col-md-4">
              <label class="form-label text-dark">
                Client Contact <span class="text-muted" id="clientContactOptional">(Optional)</span>
              </label>
              <input type="text" name="client_contact" id="clientContact" class="form-control form-control-sm">
            </div>
          </div>

        </div>

        <!-- Footer -->
        <div class="modal-footer py-2">
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm btn-success">Save Sale</button>
        </div>

      </div>
    </form>
  </div>
</div>


<!-- ──────────────────────────────────────────────── -->
<!-- JavaScript ────────────────────────────────────── -->
<!-- ──────────────────────────────────────────────── -->

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form               = document.getElementById('newSaleForm');
  const container          = document.getElementById('saleItemsContainer');
  const addBtn             = document.getElementById('btnAddItem');
  const removeBtn          = document.getElementById('btnRemoveLastItem');
  const amountPaidInput    = document.getElementById('amountPaid');
  const clientNameInput    = document.getElementById('clientName');
  const clientContactInput = document.getElementById('clientContact');
  const clientNameOpt      = document.getElementById('clientNameOptional');
  const clientContactOpt   = document.getElementById('clientContactOptional');
  const hiddenItemsJson    = document.getElementById('hiddenSaleItemsJson');
  const barcodeInput       = document.getElementById('barcodeInput');

  // ─── Core calculation helpers ────────────────────────────────
  function getTotal() {
    let total = 0;
    container.querySelectorAll('.sale-item-row').forEach(row => {
      const qty   = parseFloat(row.querySelector('.sale-qty')?.value)   || 0;
      const price = parseFloat(row.querySelector('.sale-unit-price')?.value) || 0;
      total += qty * price;
    });
    return total;
  }

  function updateAmountPaid() {
    const total = getTotal();
    amountPaidInput.value = total > 0 ? Math.round(total) : '';
  }

  function updateCreditRequirement() {
    const total = getTotal();
    const paid  = parseFloat(amountPaidInput.value) || 0;
    const isCredit = total > 0 && paid < total;

    clientNameInput.required    = isCredit;
    clientContactInput.required = isCredit;
    clientNameOpt.textContent    = isCredit ? '' : '(Optional)';
    clientContactOpt.textContent = isCredit ? '' : '(Optional)';
  }

  function updateUnitPrice(row) {
    const select     = row.querySelector('.sale-item-select');
    const priceInput = row.querySelector('.sale-unit-price');
    const idInput    = row.querySelector('.sale-item-id');

    const option = select.options[select.selectedIndex];
    const price  = option?.dataset.price || '';

    priceInput.value = price ? parseFloat(price).toFixed(0) : '';
    idInput.value    = select.value || '';
  }

  function attachRowListeners(row) {
    const select = row.querySelector('.sale-item-select');
    const qty    = row.querySelector('.sale-qty');

    select.addEventListener('change', () => {
      updateUnitPrice(row);
      updateAmountPaid();
      updateCreditRequirement();
    });

    qty.addEventListener('input', () => {
      updateAmountPaid();
      updateCreditRequirement();
    });

    // Initial population
    updateUnitPrice(row);
  }

  // ─── Add manual row ───────────────────────────────────────────
  addBtn.addEventListener('click', () => {
    const template = container.querySelector('.sale-item-row');
    if (!template) return;

    const newRow = template.cloneNode(true);

    newRow.querySelectorAll('select, input').forEach(el => {
      if (el.tagName === 'SELECT') el.selectedIndex = 0;
      else if (el.type === 'number') el.value = el.classList.contains('sale-qty') ? '1' : '';
      else el.value = '';
    });

    attachRowListeners(newRow);
    container.appendChild(newRow);
    updateAmountPaid();
    updateCreditRequirement();
  });

  // ─── Remove last row ──────────────────────────────────────────
  removeBtn.addEventListener('click', () => {
    const rows = container.querySelectorAll('.sale-item-row');
    if (rows.length <= 1) return;
    rows[rows.length - 1].remove();
    updateAmountPaid();
    updateCreditRequirement();
  });

// ─── Barcode scanner logic ────────────────────────────────────────
// Fast scanner input → auto match after short silence
// Slow typing → only match when pressing Enter

let barcodeBuffer = '';
let lastKeyTime = 0;

const SCAN_CHAR_INTERVAL_MAX = 80;      // typical scanner: < 50–70 ms between chars
const AUTO_COMMIT_DELAY     = 150;      // wait this long after last char to auto-match

function tryMatchBarcode(value) {
  if (!value.trim()) return false;

  let matchedOption = null;

  container.querySelectorAll('.sale-item-select').forEach(select => {
    if (matchedOption) return;
    for (const opt of select.options) {
      if (opt.dataset.barcode && opt.dataset.barcode === value) {
        matchedOption = opt;
        break;
      }
    }
  });

  if (!matchedOption) {
    barcodeInput.style.backgroundColor = '#fff0f0';
    setTimeout(() => { barcodeInput.style.backgroundColor = ''; }, 400);
    return false;
  }

  // Prefer filling an existing empty row
  let targetRow = null;
  const allRows = container.querySelectorAll('.sale-item-row');
  for (const row of allRows) {
    const select = row.querySelector('.sale-item-select');
    if (select && select.value === '') {
      targetRow = row;
      break;
    }
  }

  // If no empty row → create new
  if (!targetRow) {
    const template = container.querySelector('.sale-item-row');
    if (!template) return false;

    targetRow = template.cloneNode(true);

    targetRow.querySelectorAll('select, input').forEach(el => {
      if (el.tagName === 'SELECT') {
        el.selectedIndex = 0;
      } else if (el.type === 'number') {
        el.value = el.classList.contains('sale-qty') ? '1' : '';
      } else {
        el.value = '';
      }
    });

    attachRowListeners(targetRow);
    container.appendChild(targetRow);
  }

  // Populate the row
  const targetSelect = targetRow.querySelector('.sale-item-select');
  targetSelect.value = matchedOption.value;
  targetSelect.dispatchEvent(new Event('change', { bubbles: true }));

  updateUnitPrice(targetRow);
  updateAmountPaid();
  updateCreditRequirement();

  // Visual feedback
  barcodeInput.style.backgroundColor = '#e6ffe6';
  setTimeout(() => { barcodeInput.style.backgroundColor = ''; }, 300);

  barcodeInput.value = '';
  barcodeInput.focus();

  return true;
}

// ── Main input handler ────────────────────────────────────────────
barcodeInput.addEventListener('input', e => {
  const now = Date.now();

  // If typing is too slow → treat as new manual entry (reset buffer)
  if (barcodeBuffer && now - lastKeyTime > SCAN_CHAR_INTERVAL_MAX) {
    barcodeBuffer = '';
  }

  // Accumulate characters (works for typing, pasting, scanners)
  if (e.data) {
    barcodeBuffer += e.data;
  }

  lastKeyTime = now;

  // Auto-commit after short silence (scanner behavior)
  clearTimeout(window.barcodeTimeout);
  window.barcodeTimeout = setTimeout(() => {
    if (barcodeBuffer.trim()) {
      tryMatchBarcode(barcodeBuffer.trim());
      barcodeBuffer = '';
    }
  }, AUTO_COMMIT_DELAY);
});

// ── Enter key → force match for manual/slow typing ───────────────
barcodeInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault(); // stop form submission

    const valueToCheck = barcodeBuffer.trim() || barcodeInput.value.trim();

    if (valueToCheck) {
      tryMatchBarcode(valueToCheck);
      barcodeBuffer = '';
    }
  }
});

// ── Global form-level Enter prevention (only when in barcode field) ──
form.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.activeElement === barcodeInput) {
    e.preventDefault();
  }
});
  

  // ─── Form submit → collect items as JSON ──────────────────────
  form.addEventListener('submit', e => {
    const rows = container.querySelectorAll('.sale-item-row');
    const items = [];

    rows.forEach(row => {
      const itemId    = row.querySelector('.sale-item-select')?.value;
      const qty       = row.querySelector('.sale-qty')?.value;
      const unitPrice = row.querySelector('.sale-unit-price')?.value;

      if (itemId && qty && unitPrice) {
        items.push({
          item_id:   itemId,
          quantity:  qty,
          unit_price: unitPrice
        });
      }
    });

    hiddenItemsJson.value = JSON.stringify(items);
  });

  // ─── Initialize ───────────────────────────────────────────────
  const initialRow = container.querySelector('.sale-item-row');
  if (initialRow) attachRowListeners(initialRow);

  amountPaidInput.addEventListener('input', updateCreditRequirement);

  // Auto-focus barcode when modal opens
  document.getElementById('newSaleModal')
    .addEventListener('shown.bs.modal', () => {
      barcodeInput.focus();
      updateAmountPaid();
      updateCreditRequirement();
    });

  // Initial update
  updateAmountPaid();
  updateCreditRequirement();

  // Watch container changes (removals)
  new MutationObserver(() => {
    updateAmountPaid();
    updateCreditRequirement();
  }).observe(container, { childList: true, subtree: true });
});
</script>



<!-- New Expense Modal -->
<div class="modal fade" id="newExpenseModal" tabindex="-1" aria-labelledby="newExpenseModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('new_expense') }}">
      <div class="modal-content" style="background-color:#f8f9ff; font-size:.75rem;">
        <div class="modal-header border-bottom py-2">
          <h6 class="modal-title fw-semibold text-danger" id="newExpenseModalLabel">
            <i class="bi bi-receipt me-2"></i>New Expense
          </h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.85);"></button>
        </div>
        <div class="modal-body px-3 py-2">
          <input type="hidden" name="user_id" value="{{ user._id }}">
          <input type="hidden" name="org_id" value="{{ user.organization_id }}">
          {% if user.role in ['Manager', 'Admin'] %}
            <div class="mb-2">
            <label class="form-label fw-semibold text-dark">Branch</label>
            <select name="branch_id" class="form-select form-select-sm" required>
              <option value="" disabled selected>Select Branch</option>
              {% for branch in organization.branches %}
              <option value="{{ branch._id }}"
                {% if branch._id == selected_branch._id %}selected{% endif %}>
                {{ branch.branch }}
              </option>
              {% endfor %}
            </select>
            </div>
          {% else %}
            <input type="hidden" name="branch_id" value="{{ selected_branch._id }}">
          {% endif %}
          <div class="mb-2">
            <label class="form-label fw-semibold text-dark">Purpose</label>
            <input type="text" name="purpose" class="form-control form-control-sm" required>
          </div>
          <div class="mb-2">
            <label class="form-label fw-semibold text-dark">Amount (UGX)</label>
            <input type="number" name="amount" min="0" step="0.01" class="form-control form-control-sm" required>
          </div>
          <div>
            <label class="form-label fw-semibold text-dark">Authorized By</label>
            <select name="authorized_by" class="form-select form-select-sm">
              <option value="" disabled selected>Select Authorizer</option>
              {% for emp in employees %}
                {% if emp.role in ['Branch Manager','Manager'] %}
                  <option value="{{ emp._id }}">{{ emp.username }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer py-2">
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm btn-danger">Save Expense</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Transaction Detail / Edit Modals -->
{% for tx in transactions %}
  {% if tx.type == 'Sale' %}
  <div class="modal fade" id="transactionModal_{{ tx._id }}" tabindex="-1" aria-labelledby="transactionModalLabel_{{ tx._id }}" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="background-color:#f8f9ff; font-size:.72rem;">
        <div class="modal-header border-bottom py-2">
          <h6 class="modal-title fw-semibold text-success" id="transactionModalLabel_{{ tx._id }}">
            <i class="bi bi-cash-stack me-2"></i>{% if (user._id|string)==(tx.user_id|string) %}Edit Sale{% else %}Sale Details{% endif %}
          </h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.85);"></button>
        </div>
        <div class="modal-body px-3 py-2">
          <div class="mb-2 pb-2 border-bottom">
            <div class="row g-2 mb-4">
              <div class="col-6"><strong>Date:</strong> {{ tx.date.strftime('%d %b %Y') }}</div>
              <div class="col-6"><strong>Time:</strong> {{ tx.date.strftime('%I:%M %p') }}</div>
              <div class="col-6"><strong>Client:</strong> {{ tx.client_name or 'Not recorded' }}</div>
              <div class="col-6"><strong>Contact:</strong> {{ tx.client_contact or 'Not recorded' }}</div>
              <div class="col-6"><strong>Status:</strong>
          <span style="{% if tx.status=='paid' %}color:green;{% elif tx.status=='credit' %}color:red;{% else %}color:gray;{% endif %}">
            {{ tx.status|capitalize }}
          </span>
              </div>
              <div class="col-6"><strong>Items: </strong>
                <span>{{ tx.description }}</span>
              </div>
              <div class="col-6"><strong>Amount paid:</strong> 
          <span class="text-primary">
            {{ "{:,.0f}".format(tx.quantity * tx.unit_price if tx.quantity and tx.unit_price else tx.amount) }}
          </span>
              </div>
              {% if tx.status=='credit' %}
              <div class="col-6"><strong>Amount Left:</strong>
                <span class="text-danger">
                  {{ "{:,.0f}".format(tx.payment_details.amount_left) }}
                </span>
              </div>
              {% endif %}
            </div>
            {% if tx.payment_details and tx.payment_details.clearance_history %}
            <div class="mt-2">
              <strong>Clearance History:</strong>
              <div class="table-responsive">
          <table class="table table-sm table-borderless mb-0" style="font-size:.65rem;">
            <thead><tr><th>Date & Time</th><th>Amount</th></tr></thead>
            <tbody>
              {% for entry in tx.payment_details.clearance_history %}
              <tr>
                <td>{{ entry.date.strftime('%d %b %Y') }} {{ entry.date.strftime('%H:%M') }}</td>
                <td>{{ "{:,.0f}".format(entry.amount_paid) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
              </div>
            </div>
            {% endif %}
          </div>

            {% if (user._id|string)==(tx.user_id|string) %}
            <form method="POST" action="{{ url_for('edit_sale') }}">
            <input type="hidden" name="user_id" value="{{ tx.user_id }}">
            <input type="hidden" name="tx_id" value="{{ tx._id }}">
            <div id="editSaleItemsContainer_{{ tx._id }}">
              {% for sale_item in tx.sale_items %}
                <div class="row mb-2 g-2 sale-item-row" style="font-size:0.72rem;">
                <div class="col-5">
                  <label class="form-label fw-semibold text-dark" style="font-size:0.72rem;">Item</label>
                  <select class="form-select form-select-sm saleItemSelect" required style="font-size:0.72rem;">
                  <option value="" disabled>Select Item</option>
                  {% for item in stock_items %}
                  <option value="{{ item._id }}" data-price="{{ item.price }}"
                    {% if sale_item.item_id | string == item._id | string %}selected{% endif %}>
                    {{ item.name }}{% if item.price %} <!-- (ugx {{ "{:,.0f}".format(item.price) }}) --> {% endif %}
                  </option>
                  {% endfor %}
                  </select>
                  <input type="hidden" name="item_id[]" class="saleItemIdInput" value="{{ sale_item.item_id }}">
                </div>
                <div class="col-3">
                  <label class="form-label fw-semibold text-dark" style="font-size:0.72rem;">Quantity</label>
                  <input type="number" name="quantity[]" min="1" step="1" class="form-control form-control-sm saleQty" required value="{{ sale_item.quantity }}" style="font-size:0.72rem;">
                </div>
                <div class="col-4">
                  <label class="form-label fw-semibold text-dark" style="font-size:0.72rem;">Unit Price (UGX)</label>
                  <input type="number" name="unit_price[]" min="0" step="1" class="form-control form-control-sm saleUnitPrice" required style="color:blue; font-weight:500; font-size:0.72rem;" readonly value="{{ sale_item.unit_price }}">
                </div>
                </div>
                {% endfor %}
              </div>
              <div class="mb-2 d-flex gap-2">
                <button type="button" class="btn btn-sm btn-outline-primary" id="addEditSaleItemRow_{{ tx._id }}" style="font-size:0.72rem;">
                <i class="bi bi-plus-circle"></i> Add sale item
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" id="removeEditSaleItemRow_{{ tx._id }}" style="font-size:0.72rem;">
                <i class="bi bi-dash-circle"></i> Remove last item
                </button>
              </div>
            <script>
            document.addEventListener("DOMContentLoaded", function() {
              const container = document.getElementById("editSaleItemsContainer_{{ tx._id }}");
              const addBtn = document.getElementById("addEditSaleItemRow_{{ tx._id }}");
              const removeBtn = document.getElementById("removeEditSaleItemRow_{{ tx._id }}");
              const amountPaidInput = document.getElementById("editSaleAmountPaid_{{ tx._id }}");
              const clientName = document.getElementById("editSaleClientName_{{ tx._id }}");
              const clientContact = document.getElementById("editSaleClientContact_{{ tx._id }}");
              const clientNameOpt = document.getElementById("editSaleClientNameOpt_{{ tx._id }}");
              const clientContactOpt = document.getElementById("editSaleClientContactOpt_{{ tx._id }}");

              function updateUnitPrice(row) {
                const select = row.querySelector(".saleItemSelect");
                const unitPriceInput = row.querySelector(".saleUnitPrice");
                const itemIdInput = row.querySelector(".saleItemIdInput");
                const selectedOpt = select.options[select.selectedIndex];
                const price = selectedOpt ? selectedOpt.getAttribute("data-price") : "";
                unitPriceInput.value = price ? parseFloat(price).toFixed(0) : "";
                itemIdInput.value = select.value;
              }

              function attachRowEvents(row) {
                const select = row.querySelector(".saleItemSelect");
                const qtyInput = row.querySelector(".saleQty");
                select.addEventListener("change", function() {
                  updateUnitPrice(row);
                  updateTotalAmount();
                  updateCreditRequirement();
                });
                qtyInput.addEventListener("input", function() {
                  updateTotalAmount();
                  updateCreditRequirement();
                });
                // Initial update
                updateUnitPrice(row);
              }

              function updateTotalAmount() {
                const rows = container.querySelectorAll(".sale-item-row");
                let total = 0;
                rows.forEach(row => {
                  const qty = parseFloat(row.querySelector(".saleQty").value) || 0;
                  const price = parseFloat(row.querySelector(".saleUnitPrice").value) || 0;
                  total += qty * price;
                });
                if (amountPaidInput) {
                  amountPaidInput.value = total > 0 ? total.toFixed(0) : "";
                }
              }

              function updateCreditRequirement() {
                const rows = container.querySelectorAll(".sale-item-row");
                let total = 0;
                rows.forEach(row => {
                  const qty = parseFloat(row.querySelector(".saleQty").value) || 0;
                  const price = parseFloat(row.querySelector(".saleUnitPrice").value) || 0;
                  total += qty * price;
                });
                const paid = parseFloat(amountPaidInput.value) || 0;
                if (total > 0 && paid < total) {
                  if (clientName) clientName.required = true;
                  if (clientContact) clientContact.required = true;
                  if (clientNameOpt) clientNameOpt.textContent = "";
                  if (clientContactOpt) clientContactOpt.textContent = "";
                } else {
                  if (clientName) clientName.required = false;
                  if (clientContact) clientContact.required = false;
                  if (clientNameOpt) clientNameOpt.textContent = "(Optional)";
                  if (clientContactOpt) clientContactOpt.textContent = "(Optional)";
                }
              }

              // Attach events to initial row
              container.querySelectorAll(".sale-item-row").forEach(attachRowEvents);

              addBtn.addEventListener("click", function() {
                const firstRow = container.querySelector(".sale-item-row");
                if (!firstRow) return;
                const newRow = firstRow.cloneNode(true);
                // Clear values in cloned row
                newRow.querySelectorAll("select, input").forEach(el => {
                  if (el.classList.contains("saleItemSelect")) el.selectedIndex = 0;
                  else el.value = "";
                });
                attachRowEvents(newRow);
                container.appendChild(newRow);
                updateTotalAmount();
                updateCreditRequirement();
              });

              removeBtn.addEventListener("click", function() {
                const rows = container.querySelectorAll(".sale-item-row");
                if (rows.length > 1) {
                  rows[rows.length - 1].remove();
                  updateTotalAmount();
                  updateCreditRequirement();
                }
              });

              // Update total and credit requirement if any row changes (for initial row)
              container.querySelectorAll(".saleQty, .saleItemSelect").forEach(el => {
                el.addEventListener("input", function() {
                  updateTotalAmount();
                  updateCreditRequirement();
                });
                el.addEventListener("change", function() {
                  updateTotalAmount();
                  updateCreditRequirement();
                });
              });

              // Also update credit requirement if amount paid is changed
              if (amountPaidInput) {
                amountPaidInput.addEventListener("input", updateCreditRequirement);
                amountPaidInput.addEventListener("change", updateCreditRequirement);
              }

              // On form submit, collect all sale items into a list of dicts
              const saleForm = container.closest("form");
              if (saleForm) {
                saleForm.addEventListener("submit", function(e) {
                  const rows = container.querySelectorAll(".sale-item-row");
                  const items = [];
                  rows.forEach(row => {
                    const item_id = row.querySelector(".saleItemSelect").value;
                    const unit_price = row.querySelector(".saleUnitPrice").value;
                    const quantity = row.querySelector(".saleQty").value;
                    if (item_id && unit_price && quantity) {
                      items.push({
                        item_id: item_id,
                        unit_price: unit_price,
                        quantity: quantity
                      });
                    }
                  });
                  // Set to hidden input
                  let itemsInput = saleForm.querySelector("input[name='sale_items']");
                  if (!itemsInput) {
                    itemsInput = document.createElement("input");
                    itemsInput.type = "hidden";
                    itemsInput.name = "sale_items";
                    saleForm.appendChild(itemsInput);
                  }
                  itemsInput.value = JSON.stringify(items);
                });
              }

              // Initial requirement check
              updateCreditRequirement();

              // Ensure total updates when sale item rows are removed
              const observer = new MutationObserver(updateTotalAmount);
              observer.observe(container, { childList: true });
            });
            </script>
            <div class="mb-2">
              <label class="form-label fw-semibold text-dark" style="font-size:0.72rem;">Amount Paid (UGX)</label>
              <input type="number" name="amount_paid" id="editSaleAmountPaid_{{ tx._id }}" min="0" step="1" class="form-control form-control-sm" required value="{{ tx.amount }}" style="font-size:0.72rem;">
            </div>
            <div class="mb-2">
              <label class="form-label text-dark" style="font-size:0.72rem;">Client Name <span class="text-muted" id="editSaleClientNameOpt_{{ tx._id }}" style="font-size:0.72rem;">(Optional)</span></label>
              <input type="text" name="client_name" id="editSaleClientName_{{ tx._id }}" class="form-control form-control-sm" value="{{ tx.client_name or '' }}" style="font-size:0.72rem;">
            </div>
            <div>
              <label class="form-label text-dark" style="font-size:0.72rem;">Client Contact <span class="text-muted" id="editSaleClientContactOpt_{{ tx._id }}" style="font-size:0.72rem;">(Optional)</span></label>
              <input type="text" name="client_contact" id="editSaleClientContact_{{ tx._id }}" class="form-control form-control-sm" value="{{ tx.client_contact or '' }}" style="font-size:0.72rem;">
            </div>
            <div class="modal-footer py-2">
              <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal" style="font-size:0.72rem;">Cancel</button>
              <button type="submit" class="btn btn-sm btn-success" style="font-size:0.72rem;">Save Sale</button>
            </div>
            </form>
          {% else %}
          <div class="modal-footer py-2">
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {% elif tx.type == 'Expense' %}
  <div class="modal fade" id="transactionModal_{{ tx._id }}" tabindex="-1" aria-labelledby="transactionModalLabel_{{ tx._id }}" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="background-color:#f8f9ff; font-size:.72rem;">
        <div class="modal-header border-bottom py-2">
          <h6 class="modal-title fw-semibold text-danger" id="transactionModalLabel_{{ tx._id }}">
            <i class="bi bi-receipt me-2"></i>{% if (user._id|string)==(tx.user_id|string) %}Edit Expense{% else %}Expense Details{% endif %}
          </h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.85);"></button>
        </div>
        <div class="modal-body px-3 py-2">
          <div class="mb-2 pb-2 border-bottom">
            <div class="row g-2">
              <div class="col-6"><strong>Date:</strong> {{ tx.date.strftime('%d %b %Y') }}</div>
              <div class="col-6"><strong>Time:</strong> {{ tx.date.strftime('%I:%M %p') }}</div>
              <div class="col-12"><strong>Purpose:</strong> {{ tx.description or '—' }}</div>
              <div class="col-6"><strong>Amount:</strong> {{ "{:,.0f}".format(tx.amount) }}</div>
              <div class="col-6"><strong>Authorized:</strong> {{ tx.authorizer or '—' }}</div>
            </div>
          </div>
          {% if (user._id|string)==(tx.user_id|string) %}
          <form method="POST" action="{{ url_for('edit_expense') }}">
            <input type="hidden" name="user_id" value="{{ tx.user_id }}">
            <input type="hidden" name="tx_id" value="{{ tx._id }}">
            <div class="mb-2">
              <label class="form-label fw-semibold text-dark">Purpose</label>
              <input type="text" name="purpose" value="{{ tx.description }}" class="form-control form-control-sm" required>
            </div>
            <div class="mb-2">
              <label class="form-label fw-semibold text-dark">Amount (UGX)</label>
              <input type="number" name="amount" min="0" step="0.01" value="{{ tx.amount }}" class="form-control form-control-sm" required>
            </div>
            <div class="mb-2">
              <label class="form-label fw-semibold text-dark">Authorized By</label>
              <select name="authorized_by" class="form-select form-select-sm">
                <option value="" {% if not tx.authorized_by %}selected{% endif %}>Select Authorizer</option>
                {% for emp in employees %}
                  {% if emp.role == 'Branch Manager' or emp.role == 'Manager' %}
                    <option value="{{ emp._id }}" {% if (tx.authorized_by|string)==(emp._id|string) %}selected{% endif %}>{{ emp.username }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
            <div class="modal-footer py-2">
              <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-sm btn-danger">Save Expense</button>
            </div>
          </form>
          {% else %}
          <div class="modal-footer py-2">
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}
{% endfor %}

<!-- Clear Credit Modals (separate to keep table tidy) -->
{% for tx in transactions %}
  {% if tx.type == 'Sale' and tx.status == 'credit' and (tx.user_id|string) == (user._id|string) %}
  <!-- Clear Credit Modal -->
  <div class="modal fade" id="clearCreditModal_{{ tx._id }}" tabindex="-1" aria-labelledby="clearCreditLabel_{{ tx._id }}" aria-hidden="true">
    <div class="modal-dialog">
      <form method="POST" action="{{ url_for('clear_credit') }}">
        <div class="modal-content" style="background-color: #f8f9ff; font-size: 0.78rem;">
          <div class="modal-header border-bottom py-2">
        <h6 class="modal-title fw-semibold text-success" id="clearCreditLabel_{{ tx._id }}">
          <i class="bi bi-cash-coin me-2"></i>
              Clear Credit
              <span class="text-danger fw-normal" style="font-size: 0.85em;">
                ( ugx {{ "{:,.0f}".format(tx.payment_details.amount_left) }} left)
              </span>
            </h6>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="transform: scale(0.85);"></button>
          </div>
          <div class="modal-body px-3 py-2">
            <input type="hidden" name="user_id" value="{{ user._id }}">
            <input type="hidden" name="item_id" value="{{ tx.item_id }}">
            <input type="hidden" name="tx_id" value="{{ tx._id }}">
            <div class="mb-2">
              <label class="form-label fw-semibold text-dark" style="font-size: 0.72rem;">Amount to Clear (UGX)</label>
              <input type="number" name="amount" min="1" step="0.01" class="form-control form-control-sm" style="font-size: 0.72rem;" required>
            </div>
          </div>
          <div class="modal-footer py-2">
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-sm btn-success">Clear Credit</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  {% endif %}
{% endfor %}

<div class="d-flex justify-content-center mt-2">
  <nav>
    <ul class="pagination pagination-sm mb-0">
      <li class="page-item {% if page <= 1 %}disabled{% endif %}">
        <a class="page-link" href="?page={{ page - 1 }}">«</a>
      </li>
      {% set start_page = page - 2 if page - 2 > 1 else 1 %}
      {% set end_page = start_page + 5 if start_page + 5 < total_pages else total_pages %}
      {% if end_page - start_page < 5 %}
        {% set start_page = end_page - 5 if end_page - 5 > 1 else 1 %}
      {% endif %}
      {% if start_page > 1 %}
        <li class="page-item"><a class="page-link" href="?page=1">1</a></li>
        {% if start_page > 2 %}
          <li class="page-item disabled"><span class="page-link">…</span></li>
        {% endif %}
      {% endif %}
      {% for p in range(start_page, end_page + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link" href="?page={{ p }}">{{ p }}</a>
        </li>
      {% endfor %}
      {% if end_page < total_pages %}
        {% if end_page < total_pages - 1 %}
          <li class="page-item disabled"><span class="page-link">…</span></li>
        {% endif %}
        <li class="page-item"><a class="page-link" href="?page={{ total_pages }}">{{ total_pages }}</a></li>
      {% endif %}
      <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
        <a class="page-link" href="?page={{ page + 1 }}">»</a>
      </li>
    </ul>
  </nav>
</div>

{% endblock %}