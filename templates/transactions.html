{% extends "base.html" %}

{% block content %}
<div class="container-fluid" style="max-width: 1050px; font-size:.85rem;">

  <!-- Action Tiles -->
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <!-- Heading on the left -->
    <h4 class="mb-0 fw-bold" style="letter-spacing:0.5px; color: indigo;">Transactions</h4>
    <!-- Buttons on the right -->
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-sm btn-gradient-success shadow-sm px-3 py-2 d-flex align-items-center gap-2"
          data-bs-toggle="modal" data-bs-target="#newSaleModal"
          style="background: linear-gradient(90deg, #28a745 60%, #218838 100%); color: #fff; border: none; font-weight: 500; border-radius: 0.4rem;">
        <i class="bi bi-cash-stack fs-5"></i>
        <span>New Sale</span>
      </button>
      <button type="button" class="btn btn-sm btn-gradient-danger shadow-sm px-3 py-2 d-flex align-items-center gap-2"
          data-bs-toggle="modal" data-bs-target="#newExpenseModal"
          style="background: linear-gradient(90deg, #dc3545 60%, #c82333 100%); color: #fff; border: none; font-weight: 500; border-radius: 0.4rem;">
        <i class="bi bi-receipt fs-5"></i>
        <span>New Expense</span>
      </button>
    </div>
  </div>

  <!-- Transactions Table -->
  <div class="table-responsive" style="max-height: 420px; overflow-y:auto;">
    <table class="table table-hover table-sm table-borderless align-middle small mb-8" style="margin-bottom:0; font-size:.8rem; width:100%; min-width:800px;">
      <thead class="table-primary" style="position:sticky; top:0; z-index:2; background:#f8f9fa;">
      <tr>
      <th style="width:90px; min-width:70px;">Date</th>
      <th style="width:60px; min-width:60px;">Type</th>
      <th style="width:100px; min-width:80px;">User</th>
      <th style="width:140px; min-width:120px;">Description</th>
      <th style="width:55px; min-width:45px;">Qty</th>
      <th style="width:90px; min-width:80px;">Amount (UGX)</th>
      <th style="width:60px; min-width:55px;">Status</th>
      <th style="width:90px; min-width:80px;">Actions</th>
      </tr>
      </thead>
      <tbody>
      {% if transactions and transactions|length > 0 %}
      {% for tx in transactions %}
      <tr class="border-bottom">
      <td class="text-truncate" style="max-width:90px; overflow:hidden;">{{ tx.date.strftime('%d %b %Y') }}</td>
      <td class="text-truncate {% if tx.type=='Sale' %}text-success{% else %}text-danger{% endif %}" style="max-width:60px; overflow:hidden;">
      <a href="#" data-bs-toggle="modal" data-bs-target="#transactionModal_{{ tx._id }}" style="text-decoration:none; color:inherit;">
      {{ tx.type }}
      </a>
      </td>
      <td class="text-muted text-truncate" style="max-width:100px; overflow:hidden;">{{ tx.user_name }}</td>
      <td class="text-truncate" style="color: indigo; max-width:140px; overflow:hidden;" title="{{ tx.description }}">{{ tx.description }}</td>
      <td class="text-truncate" style="max-width:55px; overflow:hidden;">{{ tx.quantity if tx.quantity else '—' }}</td>
      <td class="text-truncate" style="max-width:90px; overflow:hidden;">{{ "{:,.0f}".format(tx.amount) }}</td>
      <td class="text-truncate" style="max-width:60px; overflow:hidden; {% if tx.status=='paid' %}color:green;{% elif tx.status=='credit' %}color:red;{% else %}color:gray;{% endif %}">
      {{ tx.status|capitalize if tx.status else '—' }}
      </td>
      <td class="text-truncate" style="max-width:90px; overflow:hidden;">
      <div class="d-flex flex-nowrap gap-1 justify-content-start align-items-center" style="flex-wrap:nowrap;">
      {% if (tx.type=='Sale' and (user._id|string)==(tx.user_id|string)) or (tx.type=='Expense' and (user._id|string)==(tx.user_id|string)) %}
      <button class="btn btn-xs px-2 py-0 rounded-pill text-primary fw-semibold"
      data-bs-toggle="modal" data-bs-target="#transactionModal_{{ tx._id }}"
      style="font-size:0.72rem; background:rgba(0,123,255,0.12); border:none; min-width:38px;">
        <i class="bi bi-pencil-square"></i>
      </button>
      {% else %}
      <button class="btn btn-xs px-2 py-0 rounded-pill text-primary fw-semibold"
      data-bs-toggle="modal" data-bs-target="#transactionModal_{{ tx._id }}"
      style="font-size:0.72rem; background:rgba(0,123,255,0.12); border:none; min-width:38px;">
        <i class="bi bi-eye"></i>
      </button>
      {% endif %}
      {% if tx.type == 'Sale' and tx.status == 'credit' and (tx.user_id|string) == (user._id|string) %}
      <button class="btn btn-xs px-2 py-0 rounded-pill text-success fw-semibold"
      data-bs-toggle="modal" data-bs-target="#clearCreditModal_{{ tx._id }}"
      style="font-size:0.72rem; background:rgba(40,167,69,0.12); border:none; min-width:38px;">
        Clear
      </button>
      {% endif %}
      {% if tx.type == 'Sale' %}
      <form method="POST" action="{{ url_for('print_receipt') }}" style="display:inline;">
        <input type="hidden" name="organization" value="{{ organization.organization }}">
        <input type="hidden" name="user_id" value="{{ tx.user_id }}">
        <input type="hidden" name="tx_id" value="{{ tx._id }}">
        <input type="hidden" name="organization_id" value="{{ tx.organization_id }}">
        <input type="hidden" name="date" value="{{ tx.date.strftime('%d %b %Y') }}">
        <input type="hidden" name="client_name" value="{{ tx.client_name or '' }}">
        <input type="hidden" name="client_contact" value="{{ tx.client_contact or '' }}">
        <input type="hidden" name="item" value="{{ tx.description }}">
        <input type="hidden" name="quantity" value="{{ tx.quantity }}">
        <input type="hidden" name="seller" value="{{ tx.user_name }}">
        <input type="hidden" name="branch_id" value="{{ tx.branch_id }}">
        <button type="submit"
          class="btn btn-xs px-2 py-0 rounded-pill text-primary fw-semibold"
          style="font-size:0.72rem; background:rgba(0,123,255,0.12); border:none; min-width:38px;"
          title="Print Receipt">
          <i class="bi bi-printer"></i>
        </button>
      </form>
      {% endif %}
      {% if user.role == 'Manager' %}
      <button class="btn btn-sm btn-light px-1 py-0"
      style="font-size:.7rem; line-height:1; color:#dc3545;"
      data-bs-toggle="modal" data-bs-target="#deleteTxModal_{{ tx._id }}">
      <i class="bi bi-trash" style="font-size:1em;"></i>
      </button>
      {% endif %}
      </div>
      </td>
      </tr>
      {% endfor %}
      {% else %}
      <tr>
      <td colspan="8" class="text-center text-muted fst-italic py-4">No transactions found.</td>
      </tr>
      {% endif %}
      </tbody>
    </table>

    <!-- Delete Transaction Modals -->
    {% for tx in transactions %}
      {% if (user._id|string)==(tx.user_id|string) %}
      <div class="modal fade" id="deleteTxModal_{{ tx._id }}" tabindex="-1" aria-labelledby="deleteTxLabel_{{ tx._id }}" aria-hidden="true">
      <div class="modal-dialog">
        <form method="POST" action="{{ url_for('delete_transaction') }}">
        <input type="hidden" name="tx_id" value="{{ tx._id }}">
        <input type="hidden" name="tx_type" value="{{ tx.type }}">
        <div class="modal-content" style="background-color:#fffbe9; font-size:.85rem;">
          <div class="modal-header border-bottom py-2">
          <h6 class="modal-title fw-semibold text-danger" id="deleteTxLabel_{{ tx._id }}">
            <i class="bi bi-trash me-2"></i>Delete Transaction
          </h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.85);"></button>
          </div>
          <div class="modal-body px-3 py-2">
          <div class="mb-2">
            Are you sure you want to delete this transaction?<br>
            <span class="text-muted small">This action cannot be undone.</span>
          </div>
          <div class="mb-2">
            <strong>Date:</strong> {{ tx.date.strftime('%d %b %Y') }}<br>
            <strong>Type:</strong> {{ tx.type }}<br>
            <strong>Description:</strong> {{ tx.description }}
          </div>
          </div>
          <div class="modal-footer py-2">
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm btn-danger">Delete</button>
          </div>
        </div>
        </form>
      </div>
      </div>
      {% endif %}
    {% endfor %}
    <style>
      .table td.text-truncate, .table th.text-truncate {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      /* Prevent action buttons from wrapping to next line */
      .table td .d-flex.flex-nowrap {
        flex-wrap: nowrap !important;
      }
      .table td .btn {
        min-width: 32px;
        padding-left: 0.3rem;
        padding-right: 0.3rem;
        font-size: 0.72rem;
        line-height: 1.2;
      }
      @media (max-width: 600px) {
        .table td, .table th {
          font-size: 0.72rem;
        }
        .table td .btn {
          font-size: 0.68rem;
          min-width: 28px;
          padding-left: 0.2rem;
          padding-right: 0.2rem;
        }
        .table td .d-flex.flex-nowrap {
          gap: 0.2rem !important;
        }
      }
    </style>
  </div>

</div>

<!-- New Sale Modal -->
<div class="modal fade" id="newSaleModal" tabindex="-1" aria-labelledby="newSaleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('new_sale') }}">
      <input type="hidden" name="user_id" value="{{ user._id }}">
      <input type="hidden" name="org_id" value="{{ organization._id }}">
      <div class="modal-content" style="background-color:#f8f9ff; font-size:.75rem;">
        <div class="modal-header border-bottom py-2">
          <h6 class="modal-title fw-semibold text-success" id="newSaleModalLabel">
            <i class="bi bi-cash-stack me-2"></i>New Sale
          </h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.85);"></button>
        </div>
        <div class="modal-body px-3 py-2">
          <input type="hidden" name="user_id" value="{{ user._id }}">
          {% if user.role=='Manager' %}
            <div class="mb-2">
              <label class="form-label fw-semibold text-dark">Branch</label>
              <select name="branch_id" class="form-select form-select-sm" required>
                <option value="" disabled selected>Select Branch</option>
                {% for branch in organization.branches %}
                  <option value="{{ branch._id }}"
                    {% if branch._id == selected_branch._id %}selected{% endif %}>
                    {{ branch.branch }}
                  </option>
                {% endfor %}
              </select>
            </div>
          {% else %}
            <input type="hidden" name="branch_id" value="{{ selected_branch._id }}">
          {% endif %}
          <div class="mb-2">
            <label class="form-label fw-semibold text-dark">Item</label>
            <select name="item_id" id="saleItemSelect" class="form-select form-select-sm" required>
              <option value="" disabled selected>Select Item</option>
                {% for item in stock_items %}
                <option value="{{ item._id }}" data-price="{{ item.price }}">
                  {{ item.name }}{% if item.price %} (ugx {{ "{:,.0f}".format(item.price) }}){% endif %}
                </option>
                {% endfor %}
            </select>
          </div>
            <div class="mb-2">
            <label class="form-label fw-semibold text-dark">Quantity</label>
            <input type="number" name="quantity" id="saleQty" min="1" step="1" class="form-control form-control-sm" required>
            </div>
            <div class="mb-2">
            <label class="form-label fw-semibold text-dark">Unit Price (UGX)</label>
            <input type="number" name="unit_price" id="saleUnitPrice" min="0" step="1" class="form-control form-control-sm" required style="color:blue; font-weight:500;">
            </div>
            <div class="mb-2">
            <label class="form-label fw-semibold text-dark">Amount Paid (UGX)</label>
            <input type="number" name="amount_paid" id="saleAmountPaid" min="0" step="1" class="form-control form-control-sm" required>
            </div>
          <div class="mb-2">
            <label class="form-label text-dark">Client Name <span class="text-muted" id="saleClientNameOpt">(Optional)</span></label>
            <input type="text" name="client_name" id="saleClientName" class="form-control form-control-sm">
          </div>
          <div>
            <label class="form-label text-dark">Client Contact <span class="text-muted" id="saleClientContactOpt">(Optional)</span></label>
            <input type="text" name="client_contact" id="saleClientContact" class="form-control form-control-sm">
          </div>
        </div>
        <div class="modal-footer py-2">
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm btn-success">Save Sale</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- New Expense Modal -->
<div class="modal fade" id="newExpenseModal" tabindex="-1" aria-labelledby="newExpenseModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('new_expense') }}">
      <div class="modal-content" style="background-color:#f8f9ff; font-size:.75rem;">
        <div class="modal-header border-bottom py-2">
          <h6 class="modal-title fw-semibold text-danger" id="newExpenseModalLabel">
            <i class="bi bi-receipt me-2"></i>New Expense
          </h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.85);"></button>
        </div>
        <div class="modal-body px-3 py-2">
          <input type="hidden" name="user_id" value="{{ user._id }}">
          <input type="hidden" name="org_id" value="{{ user.organization_id }}">
          {% if user.role=='Manager' %}
            <div class="mb-2">
            <label class="form-label fw-semibold text-dark">Branch</label>
            <select name="branch_id" class="form-select form-select-sm" required>
              <option value="" disabled selected>Select Branch</option>
              {% for branch in organization.branches %}
              <option value="{{ branch._id }}"
                {% if branch._id == selected_branch._id %}selected{% endif %}>
                {{ branch.branch }}
              </option>
              {% endfor %}
            </select>
            </div>
          {% endif %}
          <div class="mb-2">
            <label class="form-label fw-semibold text-dark">Purpose</label>
            <input type="text" name="purpose" class="form-control form-control-sm" required>
          </div>
          <div class="mb-2">
            <label class="form-label fw-semibold text-dark">Amount (UGX)</label>
            <input type="number" name="amount" min="0" step="0.01" class="form-control form-control-sm" required>
          </div>
          <div>
            <label class="form-label fw-semibold text-dark">Authorized By</label>
            <select name="authorized_by" class="form-select form-select-sm">
              <option value="" disabled selected>Select Authorizer</option>
              {% for emp in employees %}
                {% if emp.role in ['Branch Manager','Manager'] %}
                  <option value="{{ emp._id }}">{{ emp.username }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer py-2">
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm btn-danger">Save Expense</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Transaction Detail / Edit Modals -->
{% for tx in transactions %}
  {% if tx.type == 'Sale' %}
  <div class="modal fade" id="transactionModal_{{ tx._id }}" tabindex="-1" aria-labelledby="transactionModalLabel_{{ tx._id }}" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="background-color:#f8f9ff; font-size:.72rem;">
        <div class="modal-header border-bottom py-2">
          <h6 class="modal-title fw-semibold text-success" id="transactionModalLabel_{{ tx._id }}">
            <i class="bi bi-cash-stack me-2"></i>{% if (user._id|string)==(tx.user_id|string) %}Edit Sale{% else %}Sale Details{% endif %}
          </h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.85);"></button>
        </div>
        <div class="modal-body px-3 py-2">
          <div class="mb-2 pb-2 border-bottom">
            <div class="row g-2">
              <div class="col-6"><strong>Date:</strong> {{ tx.date.strftime('%d %b %Y') }}</div>
              <div class="col-6"><strong>Time:</strong> {{ tx.date.strftime('%I:%M %p') }}</div>
              <div class="col-6"><strong>Client:</strong> {{ tx.client_name or '—' }}</div>
              <div class="col-6"><strong>Contact:</strong> {{ tx.client_contact or '—' }}</div>
              <div class="col-6"><strong>Qty:</strong> {{ tx.quantity or '—' }}</div>
              <div class="col-6"><strong>Status:</strong>
          <span style="{% if tx.status=='paid' %}color:green;{% elif tx.status=='credit' %}color:red;{% else %}color:gray;{% endif %}">
            {{ tx.status|capitalize }}
          </span>
              </div>
              <div class="col-6"><strong>Total Amount:</strong> 
          <span class="text-primary">
            {{ "{:,.0f}".format(tx.quantity * tx.unit_price if tx.quantity and tx.unit_price else tx.amount) }}
          </span>
              </div>
              {% if tx.status=='credit' %}
              <div class="col-12"><strong>Amount Left:</strong>
          <span class="text-danger">
            {{ "{:,.0f}".format(tx.payment_details.amount_left) }}
          </span>
              </div>
              {% endif %}
            </div>
            {% if tx.payment_details and tx.payment_details.clearance_history %}
            <div class="mt-2">
              <strong>Clearance History:</strong>
              <div class="table-responsive">
          <table class="table table-sm table-borderless mb-0" style="font-size:.65rem;">
            <thead><tr><th>Date & Time</th><th>Amount</th></tr></thead>
            <tbody>
              {% for entry in tx.payment_details.clearance_history %}
              <tr>
                <td>{{ entry.date.strftime('%d %b %Y') }} {{ entry.date.strftime('%H:%M') }}</td>
                <td>{{ "{:,.0f}".format(entry.amount_paid) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
              </div>
            </div>
            {% endif %}
          </div>

            {% if (user._id|string)==(tx.user_id|string) %}
            <form method="POST" action="{{ url_for('edit_sale') }}">
            <input type="hidden" name="user_id" value="{{ tx.user_id }}">
            <input type="hidden" name="tx_id" value="{{ tx._id }}">
            <input type="hidden" name="old_item_id" value="{{ tx.item_id }}">
            <div class="row g-1">
              <div class="col-12 mb-1">
              <label class="form-label fw-semibold text-dark" style="font-size:.72rem;">Item</label>
              <select name="new_item_id" class="form-select form-select-sm" id="editSaleItem_{{ tx._id }}" required style="font-size:.72rem; padding:.2rem .4rem;">
              <option value="" disabled>Select Item</option>
              {% for item in stock_items %}
              <option value="{{ item._id }}" data-price="{{ item.price }}"
                {% if item.name == tx.description %}selected{% endif %}>
                {{ item.name }}{% if item.price %} (ugx {{ "{:,.0f}".format(item.price) }}){% endif %}
              </option>
              {% endfor %}
              </select>
              </div>
              <div class="col-6 mb-1">
              <label class="form-label fw-semibold text-dark" style="font-size:.72rem;">Qty</label>
              <input type="number" name="quantity" id="editSaleQty_{{ tx._id }}" min="1" value="{{ tx.quantity }}" class="form-control form-control-sm" required style="font-size:.72rem; padding:.2rem .4rem;">
              </div>
              <div class="col-6 mb-1">
              <label class="form-label fw-semibold text-dark" style="font-size:.72rem;">Unit Price (UGX)</label>
              <input type="number" name="unit_price" id="editSaleUnitPrice_{{ tx._id }}" min="0" step="0.01" value="{{ tx.unit_price or '' }}" class="form-control form-control-sm" required style="font-size:.72rem; padding:.2rem .4rem;">
              </div>
              <div class="col-12 mb-1">
              <label class="form-label fw-semibold text-dark" style="font-size:.72rem;">Amount Paid (UGX)</label>
              <input type="number" name="amount_paid" id="editSaleAmountPaid_{{ tx._id }}" min="0" step="0.01" value="{{ tx.amount }}" class="form-control form-control-sm" required style="font-size:.72rem; padding:.2rem .4rem;">
              </div>
              <div class="col-6 mb-1">
              <label class="form-label text-dark" style="font-size:.72rem;">Client Name <span class="text-muted" style="font-size:.7em;">(Optional)</span></label>
              <input type="text" name="client_name" value="{{ tx.client_name or '' }}" class="form-control form-control-sm" style="font-size:.72rem; padding:.2rem .4rem;">
              </div>
              <div class="col-6 mb-1">
              <label class="form-label text-dark" style="font-size:.72rem;">Client Contact <span class="text-muted" style="font-size:.7em;">(Optional)</span></label>
              <input type="text" name="client_contact" value="{{ tx.client_contact or '' }}" class="form-control form-control-sm" style="font-size:.72rem; padding:.2rem .4rem;">
              </div>
            </div>
            <div class="modal-footer py-2">
              <button type="button" class="btn btn-sm btn-secondary" style="font-size:.72rem;" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-sm btn-success" style="font-size:.72rem;">Save Sale</button>
            </div>
            </form>
          {% else %}
          <div class="modal-footer py-2">
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {% elif tx.type == 'Expense' %}
  <div class="modal fade" id="transactionModal_{{ tx._id }}" tabindex="-1" aria-labelledby="transactionModalLabel_{{ tx._id }}" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="background-color:#f8f9ff; font-size:.72rem;">
        <div class="modal-header border-bottom py-2">
          <h6 class="modal-title fw-semibold text-danger" id="transactionModalLabel_{{ tx._id }}">
            <i class="bi bi-receipt me-2"></i>{% if (user._id|string)==(tx.user_id|string) %}Edit Expense{% else %}Expense Details{% endif %}
          </h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="transform:scale(.85);"></button>
        </div>
        <div class="modal-body px-3 py-2">
          <div class="mb-2 pb-2 border-bottom">
            <div class="row g-2">
              <div class="col-6"><strong>Date:</strong> {{ tx.date.strftime('%d %b %Y') }}</div>
              <div class="col-6"><strong>Time:</strong> {{ tx.date.strftime('%I:%M %p') }}</div>
              <div class="col-12"><strong>Purpose:</strong> {{ tx.description or '—' }}</div>
              <div class="col-6"><strong>Amount:</strong> {{ "{:,.0f}".format(tx.amount) }}</div>
              <div class="col-6"><strong>Authorized:</strong> {{ tx.authorizer or '—' }}</div>
            </div>
          </div>
          {% if (user._id|string)==(tx.user_id|string) %}
          <form method="POST" action="{{ url_for('edit_expense') }}">
            <input type="hidden" name="user_id" value="{{ tx.user_id }}">
            <input type="hidden" name="tx_id" value="{{ tx._id }}">
            <div class="mb-2">
              <label class="form-label fw-semibold text-dark">Purpose</label>
              <input type="text" name="purpose" value="{{ tx.description }}" class="form-control form-control-sm" required>
            </div>
            <div class="mb-2">
              <label class="form-label fw-semibold text-dark">Amount (UGX)</label>
              <input type="number" name="amount" min="0" step="0.01" value="{{ tx.amount }}" class="form-control form-control-sm" required>
            </div>
            <div class="mb-2">
              <label class="form-label fw-semibold text-dark">Authorized By</label>
              <select name="authorized_by" class="form-select form-select-sm">
                <option value="" {% if not tx.authorized_by %}selected{% endif %}>Select Authorizer</option>
                {% for emp in employees %}
                  {% if emp.role == 'Branch Manager' or emp.role == 'Manager' %}
                    <option value="{{ emp._id }}" {% if (tx.authorized_by|string)==(emp._id|string) %}selected{% endif %}>{{ emp.username }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
            <div class="modal-footer py-2">
              <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-sm btn-danger">Save Expense</button>
            </div>
          </form>
          {% else %}
          <div class="modal-footer py-2">
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}
{% endfor %}

<!-- Clear Credit Modals (separate to keep table tidy) -->
{% for tx in transactions %}
  {% if tx.type == 'Sale' and tx.status == 'credit' and (tx.user_id|string) == (user._id|string) %}
  <!-- Clear Credit Modal -->
  <div class="modal fade" id="clearCreditModal_{{ tx._id }}" tabindex="-1" aria-labelledby="clearCreditLabel_{{ tx._id }}" aria-hidden="true">
    <div class="modal-dialog">
      <form method="POST" action="{{ url_for('clear_credit') }}">
        <div class="modal-content" style="background-color: #f8f9ff; font-size: 0.78rem;">
          <div class="modal-header border-bottom py-2">
        <h6 class="modal-title fw-semibold text-success" id="clearCreditLabel_{{ tx._id }}">
          <i class="bi bi-cash-coin me-2"></i>
              Clear Credit
              <span class="text-danger fw-normal" style="font-size: 0.85em;">
                ( ugx {{ "{:,.0f}".format(tx.payment_details.amount_left) }} left)
              </span>
            </h6>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="transform: scale(0.85);"></button>
          </div>
          <div class="modal-body px-3 py-2">
            <input type="hidden" name="user_id" value="{{ user._id }}">
            <input type="hidden" name="item_id" value="{{ tx.item_id }}">
            <input type="hidden" name="tx_id" value="{{ tx._id }}">
            <div class="mb-2">
              <label class="form-label fw-semibold text-dark" style="font-size: 0.72rem;">Amount to Clear (UGX)</label>
              <input type="number" name="amount" min="1" step="0.01" class="form-control form-control-sm" style="font-size: 0.72rem;" required>
            </div>
          </div>
          <div class="modal-footer py-2">
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-sm btn-success">Clear Credit</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
{% endfor %}

<!-- Scripts -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const saleItemSelect = document.getElementById("saleItemSelect");
  const saleUnitPrice = document.getElementById("saleUnitPrice");
  const saleQty = document.getElementById("saleQty");
  const saleAmountPaid = document.getElementById("saleAmountPaid");
  const clientName = document.getElementById("saleClientName");
  const clientContact = document.getElementById("saleClientContact");
  const clientNameOpt = document.getElementById("saleClientNameOpt");
  const clientContactOpt = document.getElementById("saleClientContactOpt");

  function computeSaleTotal() {
    const q = parseFloat(saleQty.value) || 0;
    const u = parseFloat(saleUnitPrice.value) || 0;
    if (q && u) {
      saleAmountPaid.value = (q * u).toFixed(2);
    }
    updateCreditRequirement();
  }

  function updateCreditRequirement() {
    const q = parseFloat(saleQty.value) || 0;
    const u = parseFloat(saleUnitPrice.value) || 0;
    const paid = parseFloat(saleAmountPaid.value) || 0;
    const total = q * u;
    if (total > 0 && paid < total) {
      clientName.required = true;
      clientContact.required = true;
      clientNameOpt.textContent = "";
      clientContactOpt.textContent = "";
    } else {
      clientName.required = false;
      clientContact.required = false;
      clientNameOpt.textContent = "(Optional)";
      clientContactOpt.textContent = "(Optional)";
    }
  }

  if (saleItemSelect) {
    saleItemSelect.addEventListener("change", () => {
      const opt = saleItemSelect.options[saleItemSelect.selectedIndex];
      const price = opt.getAttribute("data-price") || 0;
      saleUnitPrice.value = parseFloat(price).toFixed(2);
      computeSaleTotal();
    });
  }
  ["input","change"].forEach(ev => {
    if (saleQty) saleQty.addEventListener(ev, computeSaleTotal);
    if (saleUnitPrice) saleUnitPrice.addEventListener(ev, computeSaleTotal);
    if (saleAmountPaid) saleAmountPaid.addEventListener(ev, updateCreditRequirement);
  });

  // Edit sale modals dynamic logic
  {% for tx in transactions %}
    {% if tx.type=='Sale' %}
      (function() {
        const itemSel = document.getElementById("editSaleItem_{{ tx._id }}");
        const qty = document.getElementById("editSaleQty_{{ tx._id }}");
        const unit = document.getElementById("editSaleUnitPrice_{{ tx._id }}");
        const amt = document.getElementById("editSaleAmountPaid_{{ tx._id }}");
        if (!itemSel || !qty || !unit || !amt) return;
        function recompute() {
          const q = parseFloat(qty.value)||0;
          const u = parseFloat(unit.value)||0;
          if (q && u) amt.value = (q*u).toFixed(2);
        }
        itemSel.addEventListener("change", () => {
          const o = itemSel.options[itemSel.selectedIndex];
          const p = o.getAttribute("data-price") || 0;
            unit.value = parseFloat(p).toFixed(2);
            recompute();
        });
        qty.addEventListener("input", recompute);
        unit.addEventListener("input", recompute);
      })();
    {% endif %}
  {% endfor %}
});
</script>

{% endblock %}